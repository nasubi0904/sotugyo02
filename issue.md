# issue.md

## 2024年の記録

### 2024-XX-XX タイムラインオーバーレイ初期化エラー
- **現象**: NodeEditorWindow の初期化時に `TimelineGridOverlay` に `set_column_units` が存在せず `AttributeError` が発生する。
- **原因**: `TimelineGridOverlay` クラスでは列単位を設定するメソッド名が `set_units` のまま実装されており、ウィンドウ側の期待する `set_column_units` と不一致だった。
- **対応**: `TimelineGridOverlay` に互換メソッド `set_column_units` を追加し、内部で既存の `set_units` を呼び出すことで例外を解消。

## 2025年の記録

### タイムラインと背景の改修

#### 背景描画の刷新と縦軸対応
- **現象**: タイムライン背景が個別のグラフィックスアイテムで構成されていたため背景色や軸方向の切り替えに柔軟性がなく、描画コストも高かった。
- **原因**: 背景描画・スナップ制御が横方向固定の設計で、ビュー背景色を直接制御できない構造になっていた。
- **対応**: 背景タイル生成を `QGraphicsView` の背景ブラシ描画へ移行し、軸方向を列挙型で管理。日付ラベル・スナップ・今日マーカーを縦軸基準へ再設計した。

#### 背景テーマ更新の反映不具合
- **現象**: 背景色や縞模様の配色変更が即時反映されず、ノードエディタ内で旧テーマが残存するケースがあった。
- **原因**: 背景タイル生成時のキャッシュ鍵にテーマ情報が含まれておらず、色指定を扱う API も不足していた。
- **対応**: テーマ更新 API を追加してキャッシュを無効化する仕組みを導入し、`StripeSegment` データクラスを用いた縞配色更新を実装。NodeGraph 初期化時に縞模様背景を適用し、既存グリッド描画を無効化した。

#### 背景縞幅機構の整理
- **現象**: 運用要件で縞幅固定が求められる中、ドラッグやスライダーによる調整 UI が残存していた。
- **原因**: 過去の UI 改修で導入したドラッグ制御が背景適用ヘルパーに組み込まれたままだった。
- **対応**: `stripe_overlay.py` を含む縞幅ドラッグ関連コードを撤去し、背景適用処理を `apply_striped_background` に一本化。関連するカーソル制御も不要となり削除した。

### ノードエディタ UI/機能の調整

#### スナップ機能撤去とウィンドウ構成の見直し
- **現象**: タイムラインスナップや日付グリッドが不要となった一方で UI が旧仕様のまま残存し、`NodeEditorWindow` の責務も肥大化していた。
- **原因**: スナップ制御やツール群を単一クラスに集約していたため再利用性・保守性が低かった。
- **対応**: スナップ関連ロジックとドメインモデルを削除し、ウィンドウ構成をドック／ツールバー単位へ分割。`NodeEditorWindow` は状態管理とイベント仲介に注力する構成へ改めた。

#### ノードスナップの縦グリッド専用化
- **現象**: スナップ処理が縦横両軸に適用され、縦グリッドとの整合性が崩れるケースがあった。
- **原因**: 汎用スナップとして x/y 両軸を同じルールで丸めていたため、縦グリッドのみを重視する要求と矛盾していた。
- **対応**: スナップ処理を x 座標のみの縦グリッド揃えに限定し、UI 表記も縦グリッド専用であることを明示した。

#### 縦グリッドスナップの背景幅固定化とダイアログエラー
- **現象**: スナップ間隔設定ダイアログを開く際に `QInputDialog.getInt()` で `min` キーワードを渡したことで例外が発生し、起動直後にクラッシュした。
- **原因**: QtPy 経由の API が `min` キーワードを受け付けず、また運用要件としてスナップ幅をユーザー設定にしない方針へ変更されたため UI と処理が乖離していた。
- **対応**: 設定ダイアログ自体を撤去し、背景縞パターンの幅をそのまま縦グリッドスナップ間隔として使用するよう統一した。

#### 縦グリッドスナップ初期化順序エラー
- **現象**: スタート画面からノードエディタを開くと初期化中に `_snap_settings` が未生成のまま参照され、`AttributeError` が発生して起動できない。
- **原因**: 背景適用直後にスナップ間隔同期を呼び出す処理を `_snap_settings` 初期化より前に配置していたため、インスタンス生成順序が逆になっていた。
- **対応**: `NodeEditorWindow` のコンストラクタ内でスナップ設定データクラスを背景同期より先に初期化し、縦グリッドスナップが確実に利用できるようにした。

#### 保存操作と起動安定性の改善
- **現象**: `Ctrl+S` 実行時に確認ダイアログが表示されず意図しない上書きが発生し、同時に背景ドラッグ用コントローラが誤ったウィジェットを参照して `viewport` 属性エラーが発生する場合があった。
- **原因**: `_file_save` が確認処理を持たず、ドラッグコントローラへ `QGraphicsView` ではなく `QTabWidget` を渡していた。
- **対応**: 保存前確認用の `_confirm_save_overwrite` を導入し、ドラッグコントローラには `NodeGraph.viewer()` を渡すよう修正した。

#### Qt 互換レイヤの整備
- **現象**: NodeGraphQt 起動時に `ModuleNotFoundError` や `QtWidgets.QUndoStack` 不足が発生するケースがあった。
- **原因**: QtPy ベースへの移行後も NodeGraphQt が期待する `Qt` 名前空間や Qt6 で `QtGui` 側へ移動したクラスの再エクスポートが不足していた。
- **対応**: `sotugyo.qt_compat.ensure_qt_module_alias()` を追加し、NodeGraphQt import 前に呼び出す運用へ統一。QtGui 由来クラスを `QtWidgets` にフォールバック登録し互換性を確保した。

### ツール環境関連

#### ツール環境ノードのメタデータ強化
- **現象**: ツール環境ノードが実行ファイルパスに依存し、環境再現や将来的なメタデータ拡張に課題があった。
- **原因**: ノードがファイルパスを唯一の識別情報として扱っていた。
- **対応**: 環境定義を JSON 化する `environment_payload` を導入し、識別子とメタデータを拡張可能な形で保持するようにした。

#### Rez パッケージ登録処理の自動化
- **現象**: テンプレート探索で検出したツールに対して Rez パッケージ名や設定を手作業で用意する必要があり、登録漏れや整合性崩れが発生しやすかった。
- **原因**: テンプレート定義とは別に手動で Rez 設定を追加する運用に頼っていた。
- **対応**: テンプレート探索結果をもとに Rez パッケージ (`KDMrez` 配下の package.py) を自動生成し、テンプレート ID から自動的に Rez パッケージ名を返すようにした。

#### ツール環境ノードのメタデータ撤去とレジストリ廃止
- **現象**: ツール環境ノードのプロパティに `environment_id` / `tool_id` / `tool_name` / `version_label` / `environment_payload` が露出しており、意図せず編集できる状態だった。また、環境・ツール情報の永続化に `tooling_registry.json` が生成されていた。
- **原因**: ToolEnvironmentNode が内部識別子や JSON ペイロードをノードプロパティとして保持し、ToolConfigRepository が専用 JSON ファイルに保存する設計だった。
- **対応**: ツール環境ノードから識別子・ペイロード系プロパティを完全撤去し、Rez パッケージ検出はノード名から判定する方式へ変更。ToolConfigRepository はメモリ保持のみとし、`tooling_registry.json` の読み書きを廃止した。

#### Rez パッケージ索引の廃止と起動時スキャン対応
- **現象**: Rez パッケージの索引として `packages.json` を生成していたが、運用上はディレクトリ走査で十分になっていた。さらにツール起動時や環境更新時に実ディレクトリと一致しない索引が残るリスクがあった。
- **原因**: `RezPackageRepository` がテンプレート登録時に索引ファイルを更新する設計で、起動時のディレクトリスキャンが前提になっていなかった。
- **対応**: `packages.json` の読み書きを撤去し、起動時や更新時に Rez パッケージディレクトリを走査して内容を保持する方式へ移行した。コンテンツブラウザ更新時もスキャン結果に基づく一覧を利用する。

#### ツールノード・環境設定・環境ディレクトリの同期不足
- **現象**: コンテンツブラウザのツールノード群とツール環境設定が、環境ディレクトリの状態と一致せず乖離するケースがあった。
- **原因**: ツール登録や環境定義の更新がメモリ内で完結しており、環境ディレクトリへの反映や起動時スキャン結果との同期が不足していた。
- **対応**: ツール登録時に Rez パッケージを生成し、削除時に該当パッケージを削除するよう連携を追加した。さらに起動時・更新時に環境ディレクトリを走査してツール/環境定義を再構築し、コンテンツブラウザと設定一覧の同期を保証するようにした。

#### ツール環境ノードと Rez パッケージノードの分離
- **現象**: コンテンツブラウザにツール環境ノードと Rez パッケージノードが別カテゴリで並び、同一パッケージ由来のノードが重複表示されていた。
- **原因**: Rez パッケージを専用ノードとして扱う一方、ツール環境ノードも別経路で生成していたため、パッケージ由来の情報が統合されていなかった。
- **対応**: ツール環境ノードと Rez パッケージノードを統合し、登録済みパッケージ由来の環境定義のみからノードを生成するようにした。アイコンはパッケージ内の `.exe` から取得するよう同期ロジックを更新した。

### main エントリの終了理由判定誤り
- **現象**: Qt アプリケーションのイベントループが非ゼロの終了コードで終わった場合でも、終了理由が手動終了として扱われ、異常終了を自動検知できなかった。
- **原因**: `_run_application` で `app.exec()` の戻り値を考慮せず、例外発生時のみ `reason="error"` を付与していた。
- **対応**: イベントループの戻り値が 0 以外の場合は終了理由を強制的に `"error"` とみなし、レポート出力でも異常終了として扱うよう修正した。テストで非ゼロ終了コードをスタブし、挙動を確認した。

### ノード追加

#### 日付ノードの新設
- **目的**: タイムライン上の節目を示すラベルとして利用できるよう、入出力ポートを持たない日付専用ノードを用意する。
- **対応**: `DateNode` クラスを追加し、コンテンツブラウザとコンテキストメニューから生成できるよう登録した。既定のプロパティとして `date_label` (YYYY-MM-DD) を持ち、ノード幅・高さを初期化する。

#### 日付ノードの描画順とリサイズ挙動不足
- **現象**: 日付ノードが通常ノードと同じレイヤーに描画され、タイムラインの背景装飾として最背面に固定できず、リサイズ時も縦横のグリッドへ揃えられなかった。
- **原因**: `DateNode` を通常の `BaseNode` ベースで実装していたため、バックドロップ特有の z オーダーとスナップ付きリサイズ処理が適用されていなかった。
- **対応**: バックドロップベースの `DateNode` に置き換え、z 値を他ノードより低い位置へ固定。縦横のサイズをスナップしながら変更できるカスタムアイテムを用意し、エディタのグリッド設定と同期させた。

#### 日付ノード初期化時のスナップ設定欠落
- **現象**: 日付ノード生成直後に `_snap_grid_size` が未初期化のままサイズ変更処理が呼ばれ、`AttributeError` でノード生成が失敗する。
- **原因**: バックドロップアイテム初期化の過程でサイザー位置変更ハンドラが先に呼び出され、`_snap_grid_size` をセットする前に `_snap_value` が参照されていた。
- **対応**: バックドロップアイテムのコンストラクタ呼び出しより前に `_snap_grid_size` をデフォルト値で初期化し、生成直後でもスナップ計算が安全に行えるようにした。

#### 日付ノードのスナップ属性参照エラー再発
- **現象**: Windows 環境で日付ノード生成時に再度 `_snap_grid_size` が存在しないと判断され、`AttributeError` が発生した。
- **原因**: Qt の `itemChange` 呼び出しタイミングによっては Python 側のインスタンス属性が未構築と扱われるケースがあり、コンストラクタでセットした `_snap_grid_size` が参照できないままスナップ計算が走っていた。
- **対応**: `_snap_grid_size` をクラス属性としても定義し、`_snap_value` では `getattr` で安全に取得するようガードを追加。コンストラクタ前後どちらのタイミングでもスナップ計算に必要な値が確実に存在するようにした。

#### 日付ノードリサイズ時の無限再入クラッシュ
- **現象**: 日付ノード追加直後にログが出力されないままアプリケーションが終了することがあった。
- **原因**: スナップ後にサイズハンドルの座標を再設定する際、`on_sizer_pos_changed` が再入して無限ループとなり、Qt 側がセグメンテーションフォールトで異常終了していた。
- **対応**: 再入防止フラグと座標比較で不要な再設定を回避し、スナップ中は幅・高さのみ更新するようにしてクラッシュを抑止した。

#### 日付ノードへの子ノード吸着と自動リサイズ
- **現象**: 日付ノードにほかのノードを重ねても吸着せず、ラベルが隠れないような余白確保や子ノードの追従移動が行えなかった。
- **原因**: 日付ノードが縦方向の余白や子ノード管理を持たず、移動イベントでも子ノードの同期移動処理が存在しなかった。
- **対応**: 上下オフセット内を子ノード領域とみなし、中心が入ったノードに合わせて日付ノード高さを自動拡張する処理を追加。内側に収まったノードIDを日付ノードが保持し、日付ノード移動時に子ノードも同じだけシフトさせるようにした。

#### 日付ノード吸着処理でのプロパティ取得欠落
- **現象**: ノード移動時の吸着処理で `_safe_node_property` が未実装のまま呼ばれ、`AttributeError` により日付ノードへの吸着判定が失敗してクラッシュした。
- **原因**: 日付ノードの内側判定にサイズを安全取得するユーティリティを新設したが、呼び出し元に対応する実装を追加し忘れていた。
- **対応**: ノードプロパティ取得をラップする `_safe_node_property` を実装し、`get_property` からの取得失敗をデバッグログに残しつつ、直接属性値も浮動小数へ安全に変換するフォールバックを用意した。

#### 日付ノードの子ノード一覧表示不足
- **現象**: インスペクタの「ノード詳細」から日付ノードに吸着している子ノードを確認できず、どのノードが含まれているか判断しづらかった。
- **原因**: 日付ノードが保持する子ノードIDを UI へ露出する導線がなく、詳細パネルにも表示枠が用意されていなかった。
- **対応**: インスペクタの詳細タブに子ノード欄を追加し、日付ノード選択時に保持している子ノード名を件数付きで列挙するようにした。

#### 日付ノード移動時の子ノード追従と座標ずれ
- **現象**: 日付ノードを子ノードと一緒にドラッグすると子ノードが置いていかれたり、子ノードを外へ動かした際に意図しない位置へ逃げるようにずれてしまうことがあった。
- **原因**: 日付ノード移動時に子ノードも同時にドラッグされているケースを考慮しておらず、同一イベント内で子ノードを二重に移動していた。また、自動リサイズ時のシフト処理がドラッグ中のノードにも適用されていた。
- **対応**: ノード移動イベントで取得した移動中ノードのID集合を共有し、子ノード追従や自動リサイズに伴うシフト処理から除外するようにした。これによりドラッグ操作と自動移動が干渉せず、子ノードが確実に追従するようにした。

#### 日付ノードの位置取得不備による追従失敗
- **現象**: 日付ノードに含めた子ノードがドラッグ時に追従せず、日付ノードを動かした後に周辺ノードが意図せずずれることがあった。
- **原因**: ノード座標の取得ユーティリティ `_safe_node_pos` および `_safe_node_position` が `QPointF` を考慮しておらず、NodeGraphQt から返される座標がすべて `(0, 0)` に丸められていた。そのため日付ノード移動時の移動量がゼロと判定され、子ノードをシフトできていなかった。
- **対応**: `QtCore.QPointF` / `QtCore.QPoint` の場合も x/y から浮動小数へ変換して返すようにし、正しい移動量を計算できるようにした。これにより子ノードの追従と日付ノードの高さ調整が実際の座標に基づいて動作する。

#### 日付ノード追従移動の不具合と選択連動への置換
- **現象**: 日付ノードに子ノードを含めてドラッグしても一緒に移動せず、再度ドラッグすると周辺ノードが逃げるようにずれるなど不安定な挙動が発生した。
- **原因**: 日付ノード移動時に子ノード座標を強制的にシフトする追従処理がドラッグ中の選択状態と干渉し、NodeGraphQt の選択変更イベントと二重に位置を更新していたため。
- **対応**: 追従移動ロジックを全て撤去し、日付ノードを選択すると保持している子ノードを自動で選択に含める仕様へ変更した。これによりドラッグ操作は NodeGraphQt 標準の選択挙動に任せ、不自然な座標ずれを防止した。

#### 日付ノードの初期サイズとリサイズ挙動の不安定さ
- **現象**: 背景グリッド幅と無関係なサイズで日付ノードが生成され、リサイズ時にもサイザー位置が揺れたり描画がちらつくことがあった。
- **原因**: 日付ノードのデフォルト幅・高さを固定値で与えており、背景縞幅と噛み合っていなかった。また、サイザー再配置時に既にスナップ済みの座標へ再設定してしまい、再入時に不要な更新が発生していた。
- **対応**: 背景グリッド幅をもとに日付ノードの初期幅・高さを決定するようにし、サイザー座標が変化しない場合は再設定をスキップするガードを追加して描画の揺らぎを抑制した。

#### 日付ノードのスナップ範囲と自動リサイズの暴走
- **現象**: 日付ノードから遠いノードを動かしても縦方向の拡張が発生し、子ノード判定やスナップが広範囲に及ぶため他ノードが意図せずずれることがあった。
- **原因**: スナップ判定が日付ノードの横幅だけで行われ、上下オフセットを考慮した内側領域を踏んでいなくても高さ拡張が働いていた。また、リサイズ時の余白計算がノードの高さを考慮していなかった。
- **対応**: 日付ノードの上下オフセットを差し引いた内側矩形をスナップ有効範囲として厳密に計算し、その範囲に中心が入ったノードだけを対象に高さを拡張するようにした。拡張時は対象ノードの高さとオフセットを加味して必要な余白を算出し、内側に収まったノードのみ子ノードとして登録するよう調整した。

#### インスペクタでノードプロパティを参照できない
- **現象**: ノードグラフ上のノードを選択しても、インスペクタからノードが保持するプロパティの値を確認する術がなく、設定済みの date_label や環境メタデータの確認が手動でできなかった。
- **原因**: インスペクタの UI にプロパティ一覧の表示領域が存在せず、選択中ノードからプロパティを収集する導線を実装していなかった。
- **対応**: インスペクタに「プロパティ」タブを追加し、選択中ノードのカスタムプロパティと基本プロパティを一覧表示するようにした。ノード選択変更時にプロパティを収集して表示を更新することで、グラフ上に配置したノードの設定値を即座に確認できるようにした。

### コンテンツブラウザの行間余白の圧縮
- **現象**: コンテンツブラウザの一覧で行間・セクション間の余白が大きく、情報密度が低い印象になっていた。
- **原因**: レイアウトプロファイルの `section_spacing`/`padding` とリストの `spacing`、アイテム高さ算出時の垂直パディングが大きめに設定されていた。
- **対応**: レイアウトプロファイル・リスト設定の余白値を縮小し、アイテム高さ算出の垂直パディングを抑制して行間を詰めた。

### コンテンツブラウザのツリー化とフィルタ挙動の再設計
- **現象**: ノード追加候補が単一のリスト表示のため、ジャンル単位の階層整理や親カテゴリの展開/折りたたみが行えず、視認性と導線が不足していた。
- **原因**: `QListWidget` を前提にしたフラットな構成で、`NodeCatalogEntry` の `genre` を親階層として扱う UI 構造が存在しなかった。
- **対応**: `QTreeView` + `QStandardItemModel` を採用し、ジャンルをルート要素、ノードを子要素として再構成。フィルタ処理では子要素の表示切替と親ノードの自動展開/折りたたみを実装し、選択/ダブルクリックで `node_type_requested` を発火させるよう整理した。

### プロジェクト管理ドメインのリファクタリング

- **現象**: プロジェクト管理のルートパス正規化が各サービスに分散し、サービス単位で受け取れる型が揺れていた。また、レジストリ保存処理が読み込み・解析・永続化を単一メソッドに集約しており、レコードをミュータブルに扱う設計だった。
- **原因**: ルートパスの変換責務を共有化するユーティリティが存在せず、サービスごとに変換処理を抱え込んでいた。さらにレジストリはファイル I/O とデータ整形を分離しておらず、更新時にレコードの属性を直接変更する必要があった。
- **対応**: パス正規化を `pathing.py` に集約し、サービス層で共通利用する構成へ整理した。レジストリは読み込み・解析・保存のヘルパーを分割し、レコード更新は置換で行うように変更してデータの不変性を担保した。

### Rez/GUI 領域のリファクタリング

- **現象**: Rez 環境検証の責務が単一メソッドに集約されており、パッケージ正規化や環境変数のマージ手順が埋め込まれていた。GUI 側では Rez パッケージの表示・生成ロジックが各所に分散し、同じ判定を複数メソッドで繰り返していた。
- **原因**: Rez CLI 実行の組み立て処理を補助関数へ分割しておらず、内部ユーティリティの再利用経路が不足していた。ノードエディタは Rez パッケージの出所判定や保存先参照を専用メソッド化せず、表示ロジックへ直接埋め込んでいた。
- **対応**: Rez 環境解決の正規化・環境構築・コマンド生成を補助メソッドに分離し、実行可否判定も明示化した。ノードエディタでは Rez パッケージの出所判定とパス参照をヘルパー化し、UI の生成処理で共通利用するよう整理した。

## 2026年の記録

### テンプレート自動登録の実行ファイル環境変数名統一
- **現象**: テンプレート自動登録で生成される Rez パッケージの実行ファイル環境変数が `ADOBE_AFTER_EFFECTS_EXE` など従来形式のままで、要求された `EXECUTE_` 接頭辞ルールに一致していなかった。
- **原因**: `RezPackageRepository._render_package` がパッケージ名ベースの `*_EXE` 形式のみを出力していた。
- **対応**: 実行ファイルパスを書き込む環境変数名を `EXECUTE_{PACKAGE_NAME}_EXE` 形式へ変更し、テンプレート自動登録時の生成パッケージが新ルールに従うよう統一した。

### Rez パッケージ単位のツールノード生成不足
- **現象**: Rez パッケージディレクトリに複数の package.py があっても、コンテンツブラウザには各パッケージの代表ノードしか表示されなかった。
- **原因**: Rez パッケージ走査がパッケージ名ごとに最新ディレクトリのみを選択する設計で、package.py 単位のスキャン結果がツールノード生成に反映されていなかった。
- **対応**: Rez パッケージディレクトリを package.py ごとに走査し、バージョン別にツール/環境定義を生成するよう更新した。表示名と検出ロジックを version 付きで整理し、コンテンツブラウザ更新へ反映した。

### Tool 環境ノードの rez_info が保存されない
- **現象**: ツール環境ノードの rez_info を更新してもプロジェクト保存後に情報が消え、再読み込み時に復元できなかった。
- **原因**: NodeGraphQt のカスタムプロパティを `node.set_property` で更新していたため、`NodeModel.custom_properties` に反映されず、プロジェクト保存時の `custom_properties` 収集で取りこぼしていた。
- **対応**: `custom_properties` 辞書へ直接格納する経路を追加し、rez_info の補完・適用処理を専用ヘルパーに集約。プロジェクト読み込み時の補完後も `custom_properties` に書き戻すようにして保存を保証した。

### コンテンツブラウザのノードカタログUI刷新
- **現象**: 既存のツリー表示ではアイコン配置が縦並びに固定され、ドラッグでの配置変更やフォルダ化を行えず、ファイルシステムのような操作感に不足があった。
- **原因**: `QTreeView` を前提とした階層表示に依存し、アイコンのグリッド配置・ドロップ先フォルダの管理・並び順の保存に対応するモデルが存在しなかった。
- **対応**: `QListView` のアイコンモードをベースにしたカタログ表示へ再構成し、ドラッグ&ドロップでの並び替えやフォルダへの格納を可能にした。既定フォルダとして「ワークフロー」「環境定義」「その他」を用意し、メモ/日付ノードはワークフロー内に初期配置するよう整理した。

### コンテンツブラウザの右クリック削除操作追加
- **現象**: アイコン一覧で不要な項目を削除する際に専用の操作がなく、並び替えやフォルダ整理後に不要アイテムを消せなかった。
- **原因**: `QListView` のコンテキストメニューに削除アクションが未実装で、選択アイテムの削除導線が存在しなかった。
- **対応**: 右クリックメニューに削除操作を追加し、既定フォルダを保護した上で削除確認ダイアログを表示するようにした。

### コンテンツブラウザ上部UIの簡素化
- **現象**: 上部ヘッダーの余白が大きく、ラベルの重複表示により情報密度が低下していた。
- **原因**: タイトルや場所ラベルが重複し、各セクションの余白設定も大きめだった。
- **対応**: タイトル/場所ラベルの削除と余白・文言の簡素化でヘッダーを圧縮し、検索・操作系を短いラベルへ整理した。

### コンテンツブラウザ上部配置の再調整
- **現象**: 戻るボタン位置とフォルダ操作が検索の上にあり、視線移動が長く見た目も整理されていなかった。
- **原因**: ヘッダー内に戻るボタンを配置し、フォルダ操作がパス行に同居していた。
- **対応**: 戻るボタンを画面右上へ移し、フォルダ操作を検索の下でアイコンサイズと同じ行に配置するよう整理した。

### ホーム画面へ戻るボタンの配置移動
- **現象**: コンテンツブラウザ内に戻るボタンがあり、画面全体の右上に配置したい要求と一致していなかった。
- **原因**: 戻るボタンをコンテンツブラウザ内部で生成していた。
- **対応**: 戻るボタンをメインウィンドウの上部右寄せへ移動し、コンテンツブラウザ側からは削除した。

### コンテンツブラウザの上部余白削減
- **現象**: ドックタイトル「コンテンツブラウザ」と検索欄の間に不要な余白があり、表示密度が落ちていた。
- **原因**: ドック内コンテナの上余白とスペーシングが大きめに設定されていた。
- **対応**: ドックコンテナの上余白と縦方向スペーシングを削除し、タイトル直下に検索欄が並ぶよう調整した。

### コンテンツブラウザ初期高さの調整
- **現象**: ツール起動時の初期レイアウトでコンテンツブラウザが小さく、一覧表示が窮屈だった。
- **原因**: `resizeDocks` で指定する初期高さが小さめに固定されていた。
- **対応**: コンテンツブラウザの初期高さを拡大し、起動直後の表示領域を確保した。

### 環境定義ツールノードのアイコンが再起動後に既定へ戻る
- **現象**: テンプレート自動登録後は実行ファイル由来のアイコンが表示されるが、ツールを再起動すると環境定義ツールノードのアイコンが既定へ戻る。
- **原因**: `ToolConfigRepository` が永続化を廃止してメモリ保持のみになっていたため、再起動時に `executable_path` を復元できず `icon_path` が空になる。
- **対応**: マシン設定ディレクトリ配下へツール登録情報を保存する永続化を復帰し、再起動後も `executable_path` が復元されるようにした。

### ツールノードから Rez 環境を起動できない
- **現象**: ツール環境ノードに Rez パッケージ情報が付与されていても、UI 側に起動導線がなく、rez_launch.py を利用した起動が行えなかった。
- **原因**: ノード選択時に `rez_info` の内容を UI へ反映する設計がなく、ローカルの KDMrez 参照と起動 API を結び付ける処理が未実装だった。
- **対応**: インスペクタのプロパティ欄に起動ボタンを追加し、`rez_info` からローカル Rez パッケージを特定して `launch_rez_detached` を実行する導線を実装した。

### Rez パッケージ未同期警告の誤表示
- **現象**: プロジェクトが Rez パッケージをマニフェストのみで管理する運用でも、KDMrez に存在するパッケージがプロジェクトへ同期されていないという警告が表示された。
- **原因**: `node_editor.py` の Rez パッケージ検証で、ローカルに存在するがプロジェクト配下にコピーされていないパッケージを常に警告対象としていた。
- **対応**: マニフェスト運用に合わせ、プロジェクト未同期パッケージの警告表示を撤去した。

### Tools メニューのラベル不一致と起動環境導線不足
- **現象**: Tools メニュー内の「環境設定...」が要求された文言と一致せず、起動環境の構成ダイアログを直接開く導線が存在しなかった。
- **原因**: ツール登録のみを想定したメニュー構成のまま更新されておらず、起動環境編集用ダイアログの起動アクションが未追加だった。
- **対応**: メニューラベルを「ツールの確認と編集...」へ変更し、起動環境管理ダイアログを開く「起動環境の構成...」アクションを追加した。
### コンテンツブラウザの貼り付け導線と既定フォルダ整理
- **現象**: 空白領域を右クリックしても貼り付け操作ができず、既定フォルダ内で貼り付けできてしまう可能性があった。さらに「その他」フォルダが既定として常時表示されていた。
- **原因**: コンテキストメニューが選択項目のみに反応しており、貼り付け用の導線が存在しなかった。また既定フォルダ定義から「その他」を除外する整理が未実施だった。
- **対応**: 空白領域の右クリックで貼り付けを提示し、既定フォルダ内では貼り付けを無効化するガードを追加した。既定フォルダ構成から「その他」を削除した。

### コンテンツブラウザのレイアウト永続化
- **現象**: コンテンツブラウザでフォルダの並び替えや追加を行っても、再起動時にレイアウトが初期状態へ戻っていた。
- **原因**: アイコン配置やフォルダ構成をユーザーローカルへ保存する仕組みがなく、編集内容がセッション内でのみ保持されていた。
- **対応**: レイアウト構造を JSON 化して設定ストアへ保存し、編集操作ごとに同期する永続化処理を追加した。

### コンテンツブラウザのコピー項目が復元時に反映されない
- **現象**: コピーや貼り付けで追加した項目が再起動後に既定の一覧と一致せず、アイコンが空になったり意図した配置が反映されない場合があった。
- **原因**: レイアウト復元時に `entry=None` の項目が `node_type` として扱われず、カタログ同期で既存エントリとして判定されなかったため、復元後に重複追加やアイコン未設定が発生していた。
- **対応**: `entry` が未設定の項目でも `title` を `node_type` として扱うキー解決を追加し、復元時に既存エントリへ正しく紐付くよう同期ロジックを修正した。

### ワークフロー用ファイルノードの追加
- **依頼**: ワークフローにファイルノードを追加し、ファイルパスをカスタムプロパティとして保持したい。
- **対応**: ファイルノードを新設して `file_path` をカスタムプロパティに保持し、インスペクタのプロパティ欄にファイルパス入力と「エクスプローラーで表示」ボタンを追加した。ボタン押下時は OS ごとのファイルマネージャーを起動して対象パスを表示する。

### コンテンツブラウザへの外部ファイルドロップ対応
- **依頼**: コンテンツブラウザへ外部ファイルをドラッグ&ドロップした際、ユーザーローカルカタログにファイルノードとして登録し、既定フォルダ内では禁止したい。
- **対応**: 外部ファイルドロップ時にファイルノード用エントリを生成し、ファイルパスとアイコンを保持するユーザーエントリとして保存する導線を追加した。既定フォルダ内へドロップされた場合は警告を表示して登録を抑止する。
