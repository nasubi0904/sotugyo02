# issue.md

## 2024年の記録

### 2024-XX-XX タイムラインオーバーレイ初期化エラー
- **現象**: NodeEditorWindow の初期化時に `TimelineGridOverlay` に `set_column_units` が存在せず `AttributeError` が発生する。
- **原因**: `TimelineGridOverlay` クラスでは列単位を設定するメソッド名が `set_units` のまま実装されており、ウィンドウ側の期待する `set_column_units` と不一致だった。
- **対応**: `TimelineGridOverlay` に互換メソッド `set_column_units` を追加し、内部で既存の `set_units` を呼び出すことで例外を解消。

## 2025年の記録

### タイムラインと背景の改修

#### 背景描画の刷新と縦軸対応
- **現象**: タイムライン背景が個別のグラフィックスアイテムで構成されていたため背景色や軸方向の切り替えに柔軟性がなく、描画コストも高かった。
- **原因**: 背景描画・スナップ制御が横方向固定の設計で、ビュー背景色を直接制御できない構造になっていた。
- **対応**: 背景タイル生成を `QGraphicsView` の背景ブラシ描画へ移行し、軸方向を列挙型で管理。日付ラベル・スナップ・今日マーカーを縦軸基準へ再設計した。

#### 背景テーマ更新の反映不具合
- **現象**: 背景色や縞模様の配色変更が即時反映されず、ノードエディタ内で旧テーマが残存するケースがあった。
- **原因**: 背景タイル生成時のキャッシュ鍵にテーマ情報が含まれておらず、色指定を扱う API も不足していた。
- **対応**: テーマ更新 API を追加してキャッシュを無効化する仕組みを導入し、`StripeSegment` データクラスを用いた縞配色更新を実装。NodeGraph 初期化時に縞模様背景を適用し、既存グリッド描画を無効化した。

#### 背景縞幅機構の整理
- **現象**: 運用要件で縞幅固定が求められる中、ドラッグやスライダーによる調整 UI が残存していた。
- **原因**: 過去の UI 改修で導入したドラッグ制御が背景適用ヘルパーに組み込まれたままだった。
- **対応**: `stripe_overlay.py` を含む縞幅ドラッグ関連コードを撤去し、背景適用処理を `apply_striped_background` に一本化。関連するカーソル制御も不要となり削除した。

### ノードエディタ UI/機能の調整

#### スナップ機能撤去とウィンドウ構成の見直し
- **現象**: タイムラインスナップや日付グリッドが不要となった一方で UI が旧仕様のまま残存し、`NodeEditorWindow` の責務も肥大化していた。
- **原因**: スナップ制御やツール群を単一クラスに集約していたため再利用性・保守性が低かった。
- **対応**: スナップ関連ロジックとドメインモデルを削除し、ウィンドウ構成をドック／ツールバー単位へ分割。`NodeEditorWindow` は状態管理とイベント仲介に注力する構成へ改めた。

#### ノードスナップの縦グリッド専用化
- **現象**: スナップ処理が縦横両軸に適用され、縦グリッドとの整合性が崩れるケースがあった。
- **原因**: 汎用スナップとして x/y 両軸を同じルールで丸めていたため、縦グリッドのみを重視する要求と矛盾していた。
- **対応**: スナップ処理を x 座標のみの縦グリッド揃えに限定し、UI 表記も縦グリッド専用であることを明示した。

#### 縦グリッドスナップの背景幅固定化とダイアログエラー
- **現象**: スナップ間隔設定ダイアログを開く際に `QInputDialog.getInt()` で `min` キーワードを渡したことで例外が発生し、起動直後にクラッシュした。
- **原因**: QtPy 経由の API が `min` キーワードを受け付けず、また運用要件としてスナップ幅をユーザー設定にしない方針へ変更されたため UI と処理が乖離していた。
- **対応**: 設定ダイアログ自体を撤去し、背景縞パターンの幅をそのまま縦グリッドスナップ間隔として使用するよう統一した。

#### 縦グリッドスナップ初期化順序エラー
- **現象**: スタート画面からノードエディタを開くと初期化中に `_snap_settings` が未生成のまま参照され、`AttributeError` が発生して起動できない。
- **原因**: 背景適用直後にスナップ間隔同期を呼び出す処理を `_snap_settings` 初期化より前に配置していたため、インスタンス生成順序が逆になっていた。
- **対応**: `NodeEditorWindow` のコンストラクタ内でスナップ設定データクラスを背景同期より先に初期化し、縦グリッドスナップが確実に利用できるようにした。

#### 保存操作と起動安定性の改善
- **現象**: `Ctrl+S` 実行時に確認ダイアログが表示されず意図しない上書きが発生し、同時に背景ドラッグ用コントローラが誤ったウィジェットを参照して `viewport` 属性エラーが発生する場合があった。
- **原因**: `_file_save` が確認処理を持たず、ドラッグコントローラへ `QGraphicsView` ではなく `QTabWidget` を渡していた。
- **対応**: 保存前確認用の `_confirm_save_overwrite` を導入し、ドラッグコントローラには `NodeGraph.viewer()` を渡すよう修正した。

#### Qt 互換レイヤの整備
- **現象**: NodeGraphQt 起動時に `ModuleNotFoundError` や `QtWidgets.QUndoStack` 不足が発生するケースがあった。
- **原因**: QtPy ベースへの移行後も NodeGraphQt が期待する `Qt` 名前空間や Qt6 で `QtGui` 側へ移動したクラスの再エクスポートが不足していた。
- **対応**: `sotugyo.qt_compat.ensure_qt_module_alias()` を追加し、NodeGraphQt import 前に呼び出す運用へ統一。QtGui 由来クラスを `QtWidgets` にフォールバック登録し互換性を確保した。

### ツール環境関連

#### ツール環境ノードのメタデータ強化
- **現象**: ツール環境ノードが実行ファイルパスに依存し、環境再現や将来的なメタデータ拡張に課題があった。
- **原因**: ノードがファイルパスを唯一の識別情報として扱っていた。
- **対応**: 環境定義を JSON 化する `environment_payload` を導入し、識別子とメタデータを拡張可能な形で保持するようにした。

#### Rez パッケージ登録処理の自動化
- **現象**: テンプレート探索で検出したツールに対して Rez パッケージ名や設定を手作業で用意する必要があり、登録漏れや整合性崩れが発生しやすかった。
- **原因**: テンプレート定義とは別に手動で Rez 設定を追加する運用に頼っていた。
- **対応**: テンプレート探索結果をもとに Rez パッケージ (`KDMrez` 配下の package.py) を自動生成し、テンプレート ID から自動的に Rez パッケージ名を返すようにした。

### main エントリの終了理由判定誤り
- **現象**: Qt アプリケーションのイベントループが非ゼロの終了コードで終わった場合でも、終了理由が手動終了として扱われ、異常終了を自動検知できなかった。
- **原因**: `_run_application` で `app.exec()` の戻り値を考慮せず、例外発生時のみ `reason="error"` を付与していた。
- **対応**: イベントループの戻り値が 0 以外の場合は終了理由を強制的に `"error"` とみなし、レポート出力でも異常終了として扱うよう修正した。テストで非ゼロ終了コードをスタブし、挙動を確認した。

### Rez PATH 事前設定の不足
- **現象**: Rez CLI が OS の PATH に含まれていない環境でツールを起動すると、Rez 環境検証が実行前に失敗し、パッケージ解決を試せない。
- **原因**: ツール起動時に Rez のインストールディレクトリを PATH に追加する仕組みがなく、環境変数で Rez パスを渡しても活用していなかった。
- **対応**: `SOTUGYO_REZ_PATH` 環境変数に指定されたディレクトリを PATH / Path の先頭に追加する処理を Rez 環境リゾルバ初期化時に導入し、PATH 未設定の環境でも Rez CLI を検出できるようにした。

### Rez PATH ヒントが初期化時しか反映されない
- **現象**: アプリ起動後に `SOTUGYO_REZ_PATH` を設定しても Rez 検証でパスが参照されず、`rez コマンドが見つかりません。` の警告が表示される。
- **原因**: RezEnvironmentResolver が初期化時に一度だけ PATH を更新しており、検証実行時に最新の `SOTUGYO_REZ_PATH` を取り込んでいなかった。
- **対応**: 検証直前に毎回環境変数を再構築し、現在の `SOTUGYO_REZ_PATH` を PATH へマージしてから `shutil.which` とサブプロセス起動に渡すよう修正。初期化時にも同じロジックで PATH を更新し後続処理に伝搬させるようにした。

#### Rez 環境設定の保存先統一と編集メニュー撤去
- **現象**: ツール環境設定が複数のディレクトリに分散し、ノードエディタから手動編集メニューを開けてしまうため、プロジェクト保存時にどの設定が使われるか判別しづらい。
- **原因**: Rez パッケージとツール／環境設定の保存先が別ディレクトリのままで、プロジェクト読み込み時も Rez CLI への直接検証に依存していた。
- **対応**: ローカル設定の保存先を KDMrez (`AppData/Local/KDMrez`) に統一し、ノードエディタの「ツール環境の編集」メニューを削除。プロジェクト読み込み時は KDMrez にある Rez パッケージ定義の有無で突き合わせ検証するように変更した。

#### Rez パッケージ同期とプロジェクト検証
- **現象**: KDMrez に存在する Rez パッケージをプロジェクトへ配布できず、プロジェクト展開時にパッケージ欠落へ気付きにくかった。
- **原因**: パッケージ検出とノード生成が KDMrez 前提で、プロジェクト側へのコピーや整合性チェックが未実装だった。
- **対応**: コンテンツブラウザから KDMrez／プロジェクト内のパッケージを直接ノード化できるようにし、プロジェクト保存時に参照パッケージを `config/rez_packages` へ同期する処理を追加。プロジェクト読み込み時はローカル／プロジェクト双方のパッケージ有無と`package.py` の整合性を検証し、欠落・破損を警告するようにした。

### ノード幅のグリッド揃えと Rez 起動ボタン追加
- **現象**: 背景縦グリッドに対してノード幅が中途半端な値のまま生成され、ツール環境ノードを Rez 経由で起動する手段も用意されていなかった。
- **原因**: ノード生成・読み込み時に幅を背景縞幅へ丸める処理がなく、インスペクタにも Rez 起動ボタンが存在しなかったため。
- **対応**: 背景の縞幅を基準にノード幅を丸めるユーティリティを追加し、ツール環境ノード選択時に Rez 環境で起動するボタンをインスペクタへ配置。Rez 解決失敗やコマンド不在、実行権限不足を個別に通知するエラーハンドリングを追加した。

### Rez パッケージ選択とツールノードの紐付け不足
- **現象**: Rez パッケージの最新版がファイル更新日時で誤判定され、maya/2024 と maya/2025 のような構成で古いバージョンが選ばれることがあった。また、ツール環境ノードが Rez パッケージ名を保持しておらず、プロジェクト側のパッケージとローカルパッケージを突き合わせられないため起動判定が曖昧だった。
- **原因**: RezPackageRepository が更新日時を基準に package.py を選択しており、バージョン番号の大小を考慮していなかった。ツールノードも Rez パッケージ名をプロパティとして持たず、ノード保存時のカスタム情報に記録されていなかった。
- **対応**: バージョンディレクトリを packaging.version に基づいて降順選択し、未知の名前はフォールバックしつつ base ディレクトリを最後に候補とするよう修正。ツール環境ノードへ rez_package_name プロパティを追加し、ノード生成時にツール名をデフォルト表示名とすることでプロジェクト／ローカル双方のパッケージ有無を突き合わせて警告・起動制御できるようにした。

### 登録済みツールを紐付けたノードが起動失敗する
- **現象**: ツールを登録済みでも、古いノードやプロジェクトから読み込んだノードでは「対応するツールが登録されていません。」と表示され、起動できないケースがあった。
- **原因**: ノードのペイロードに保存された tool_id が空または古い UUID のまま残っている場合、現在登録されているツールを参照できず照合に失敗していた。
- **対応**: ボタン押下時にテンプレート ID やツール名から登録済みツールを再検索し、見つかった場合はノードの tool_id とペイロードを更新して起動に利用するようにした。

### 登録ツールの整合処理が UI に残っている
- **現象**: ツール環境ノード起動時の登録ツール再照合を UI 層で行っており、Rez 依存の突き合わせ処理と責務が分散していた。
- **原因**: Rez 環境リゾルバが登録ツールの突き合わせ機能を持たず、UI 側で補正ロジックを抱えていたため。
- **対応**: 登録ツールとの突き合わせ・補正を RezEnvironmentResolver に集約し、ノード起動時は Rez 経由の結果を用いてペイロード更新と紐付けを行うようにした。

### 登録ツールの Rez パッケージを参照できない
- **現象**: ツール環境設定ダイアログで登録済みツールを選択しても、対応する Rez パッケージ名を確認できず、環境定義の Rez パッケージ欄へ手入力する必要があった。インスペクタでもノードが保持するプロパティを一覧で確認できなかった。
- **原因**: 登録ツールから Rez パッケージ名を解決するユーティリティがなく、UI への表示や入力補助に利用していなかった。またインスペクタにはプロパティ表示用のセクションが用意されていなかった。
- **対応**: 登録ツールから Rez パッケージ名を取得する API を追加し、ツール一覧と環境定義入力フォームで参照・自動補完できるようにした。併せてインスペクタにプロパティ一覧タブを設け、ノードが保持する全カスタムプロパティを確認できるようにした。

### ノードに埋め込む Rez パッケージ名がローカル登録とずれる
- **現象**: 登録済みツールから生成した環境ノードでも、入力やテンプレート依存で Rez パッケージ名が揃わず、別プロジェクトへ持ち出した際にローカルのパッケージと突き合わせできないことがあった。
- **原因**: 環境定義の保存やノード生成・起動時に、登録ツールと Rez リポジトリから得られる正規パッケージ名への補正処理がなく、入力値がそのままペイロードへ保存されていたため。
- **対応**: 環境保存時に登録ツールから解決したパッケージ名を先頭へ揃え、ノード生成・起動時も Rez リポジトリで解決した名称をペイロードとプロパティへ反映することで、プロジェクトをまたいでも同一名称を共有できるようにした。

### Rez パッケージ名だけを保持するノードで登録ツールを見つけられない
- **現象**: ローカルでツールを登録済みでも、古いプロジェクトや Rez パッケージ専用ノードでは「対応するツールが登録されていません。」と警告され起動できないことがあった。
- **原因**: 登録ツールとの突き合わせを tool_id / テンプレート ID / ツール名のみに依存しており、ノードに残っている Rez パッケージ名と登録ツールのパッケージ名を突き合わせていなかったため。
- **対応**: RezEnvironmentResolver に登録ツールのパッケージ名マップを受け渡し、ペイロード内の Rez パッケージ名から登録ツールを再特定して tool_id / tool_name を補正するようにした。UI 側で登録ツールごとの Rez パッケージ名を事前解決してリゾルバに渡し、パッケージ名しか保持していないノードでも起動できるようにした。
