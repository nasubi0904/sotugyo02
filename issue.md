# issue.md

## 2024年の記録

### 2024-XX-XX タイムラインオーバーレイ初期化エラー
- **現象**: NodeEditorWindow の初期化時に `TimelineGridOverlay` に `set_column_units` が存在せず `AttributeError` が発生する。
- **原因**: `TimelineGridOverlay` クラスでは列単位を設定するメソッド名が `set_units` のまま実装されており、ウィンドウ側の期待する `set_column_units` と不一致だった。
- **対応**: `TimelineGridOverlay` に互換メソッド `set_column_units` を追加し、内部で既存の `set_units` を呼び出すことで例外を解消。

## 2025年の記録

### タイムラインと背景の改修

#### 背景描画の刷新と縦軸対応
- **現象**: タイムライン背景が個別のグラフィックスアイテムで構成されていたため背景色や軸方向の切り替えに柔軟性がなく、描画コストも高かった。
- **原因**: 背景描画・スナップ制御が横方向固定の設計で、ビュー背景色を直接制御できない構造になっていた。
- **対応**: 背景タイル生成を `QGraphicsView` の背景ブラシ描画へ移行し、軸方向を列挙型で管理。日付ラベル・スナップ・今日マーカーを縦軸基準へ再設計した。

#### 背景テーマ更新の反映不具合
- **現象**: 背景色や縞模様の配色変更が即時反映されず、ノードエディタ内で旧テーマが残存するケースがあった。
- **原因**: 背景タイル生成時のキャッシュ鍵にテーマ情報が含まれておらず、色指定を扱う API も不足していた。
- **対応**: テーマ更新 API を追加してキャッシュを無効化する仕組みを導入し、`StripeSegment` データクラスを用いた縞配色更新を実装。NodeGraph 初期化時に縞模様背景を適用し、既存グリッド描画を無効化した。

#### 背景縞幅機構の整理
- **現象**: 運用要件で縞幅固定が求められる中、ドラッグやスライダーによる調整 UI が残存していた。
- **原因**: 過去の UI 改修で導入したドラッグ制御が背景適用ヘルパーに組み込まれたままだった。
- **対応**: `stripe_overlay.py` を含む縞幅ドラッグ関連コードを撤去し、背景適用処理を `apply_striped_background` に一本化。関連するカーソル制御も不要となり削除した。

### ノードエディタ UI/機能の調整

#### スナップ機能撤去とウィンドウ構成の見直し
- **現象**: タイムラインスナップや日付グリッドが不要となった一方で UI が旧仕様のまま残存し、`NodeEditorWindow` の責務も肥大化していた。
- **原因**: スナップ制御やツール群を単一クラスに集約していたため再利用性・保守性が低かった。
- **対応**: スナップ関連ロジックとドメインモデルを削除し、ウィンドウ構成をドック／ツールバー単位へ分割。`NodeEditorWindow` は状態管理とイベント仲介に注力する構成へ改めた。

#### ノードスナップの縦グリッド専用化
- **現象**: スナップ処理が縦横両軸に適用され、縦グリッドとの整合性が崩れるケースがあった。
- **原因**: 汎用スナップとして x/y 両軸を同じルールで丸めていたため、縦グリッドのみを重視する要求と矛盾していた。
- **対応**: スナップ処理を x 座標のみの縦グリッド揃えに限定し、UI 表記も縦グリッド専用であることを明示した。

#### 縦グリッドスナップの背景幅固定化とダイアログエラー
- **現象**: スナップ間隔設定ダイアログを開く際に `QInputDialog.getInt()` で `min` キーワードを渡したことで例外が発生し、起動直後にクラッシュした。
- **原因**: QtPy 経由の API が `min` キーワードを受け付けず、また運用要件としてスナップ幅をユーザー設定にしない方針へ変更されたため UI と処理が乖離していた。
- **対応**: 設定ダイアログ自体を撤去し、背景縞パターンの幅をそのまま縦グリッドスナップ間隔として使用するよう統一した。

#### 縦グリッドスナップ初期化順序エラー
- **現象**: スタート画面からノードエディタを開くと初期化中に `_snap_settings` が未生成のまま参照され、`AttributeError` が発生して起動できない。
- **原因**: 背景適用直後にスナップ間隔同期を呼び出す処理を `_snap_settings` 初期化より前に配置していたため、インスタンス生成順序が逆になっていた。
- **対応**: `NodeEditorWindow` のコンストラクタ内でスナップ設定データクラスを背景同期より先に初期化し、縦グリッドスナップが確実に利用できるようにした。

#### 保存操作と起動安定性の改善
- **現象**: `Ctrl+S` 実行時に確認ダイアログが表示されず意図しない上書きが発生し、同時に背景ドラッグ用コントローラが誤ったウィジェットを参照して `viewport` 属性エラーが発生する場合があった。
- **原因**: `_file_save` が確認処理を持たず、ドラッグコントローラへ `QGraphicsView` ではなく `QTabWidget` を渡していた。
- **対応**: 保存前確認用の `_confirm_save_overwrite` を導入し、ドラッグコントローラには `NodeGraph.viewer()` を渡すよう修正した。

#### Qt 互換レイヤの整備
- **現象**: NodeGraphQt 起動時に `ModuleNotFoundError` や `QtWidgets.QUndoStack` 不足が発生するケースがあった。
- **原因**: QtPy ベースへの移行後も NodeGraphQt が期待する `Qt` 名前空間や Qt6 で `QtGui` 側へ移動したクラスの再エクスポートが不足していた。
- **対応**: `sotugyo.qt_compat.ensure_qt_module_alias()` を追加し、NodeGraphQt import 前に呼び出す運用へ統一。QtGui 由来クラスを `QtWidgets` にフォールバック登録し互換性を確保した。

### ツール環境関連

#### ツール環境ノードのメタデータ強化
- **現象**: ツール環境ノードが実行ファイルパスに依存し、環境再現や将来的なメタデータ拡張に課題があった。
- **原因**: ノードがファイルパスを唯一の識別情報として扱っていた。
- **対応**: 環境定義を JSON 化する `environment_payload` を導入し、識別子とメタデータを拡張可能な形で保持するようにした。

#### Rez パッケージ登録処理の自動化
- **現象**: テンプレート探索で検出したツールに対して Rez パッケージ名や設定を手作業で用意する必要があり、登録漏れや整合性崩れが発生しやすかった。
- **原因**: テンプレート定義とは別に手動で Rez 設定を追加する運用に頼っていた。
- **対応**: テンプレート探索結果をもとに Rez パッケージ (`KDMrez` 配下の package.py) を自動生成し、テンプレート ID から自動的に Rez パッケージ名を返すようにした。

#### ツール環境ノードの起動ボタン追加
- **現象**: ツール環境ノードのプロパティから Rez 環境を起動する手段がなく、environment_id を参照して手動で起動する必要があった。
- **原因**: インスペクタ側に起動アクションが用意されておらず、環境定義に紐づく Rez パッケージの存在確認と起動処理が UI から呼び出せなかった。
- **対応**: インスペクタのプロパティタブに起動ボタンを追加し、environment_id から環境定義を取得してローカル Rez パッケージの package.py を確認したうえで `rez env` 経由でツールを起動するフローを実装した。

#### ツール登録と環境定義の統合
- **現象**: ツール登録と環境定義が分離されていたため、環境一覧がツール登録に依存し、Rez パッケージ中心の運用と整合しなかった。
- **原因**: 環境定義が RegisteredTool に依存する設計のまま残り、ツール登録が別テーブルとして維持されていた。
- **対応**: ツール登録時に Rez パッケージを生成し、そのまま環境定義として保存するフローへ統合した。環境定義は Rez パッケージと実行ファイル情報を保持し、ツール一覧は環境一覧へ置き換えた。

#### 環境定義の Rez パッケージ表記にバージョン制約を追加
- **現象**: 環境定義の `rez_packages` にバージョン制約が含まれず、`autodesk_maya-2025` のような本来のパッケージ指定になっていなかった。
- **原因**: `rez_packages` の正規化処理で `version_label` を参照せず、ベース名のみを保存していた。
- **対応**: 環境定義保存時に `tool_id` と `version_label` を参照し、該当パッケージには `-<version>` を付与するよう調整した。

#### ダミーツール起動の統合テスト追加
- **現象**: 環境登録からノードの `environment_id` に相当する起動フローが自動テストで検証されていなかった。
- **原因**: Rez 起動処理が導入されたものの、実際にダミーツールを起動して成功を確認するテストが存在しなかった。
- **対応**: `dummyTool.exe.test` を使った統合テストを追加し、Rez 経由の起動で成果ファイルが生成されることを検証した。

#### environment_id の撤廃とパッケージ名統一
- **現象**: 環境識別に `environment_id` が残り、パッケージ名ベースの運用と二重管理になっていた。
- **原因**: ノードや環境定義が `environment_id` を前提としていたため、起動処理や UI がパッケージ名で統一されていなかった。
- **対応**: `environment_id` を撤廃し、ノードは `package_name` を保持するよう変更した。環境定義・UI・起動処理はすべてパッケージ名で参照するよう統一し、Rez 経由の処理は標準出力を受け取って print するようにした。

#### Rez 実行の呼び出しを python -m rez に統一
- **現象**: Rez 実行が `rez` コマンド前提になっており、現在の Python 環境にインストールされた Rez を利用できていなかった。
- **原因**: Rez 実行コマンドを `rez env` で固定していた。
- **対応**: Rez 実行をすべて `python -m rez env` へ統一し、標準出力／標準エラーを print する運用に合わせてテストも更新した。

#### sys.executable 基準で Scripts 配下の rez を実行
- **現象**: `python -m rez` の呼び出しのみで実行していたため、Scripts 配下の `rez` へ直接解決して実行する要件に合致しなかった。
- **原因**: Rez 実行コマンドの解決が `sys.executable` の親ディレクトリ配下の `rez` 実体を探索していなかった。
- **対応**: `sys.executable` のパスを起点に `Scripts/rez`（Windows）や `bin/rez`（POSIX）を探索して実行するように変更し、テストも更新した。

#### Rez 呼び出しの subprocess 依存撤廃 (2025-12-19)
- **現象**: Rez 環境の解決・起動が `subprocess` 経由の `rez env` 呼び出しに依存しており、Python API を利用する要件に合致しなかった。
- **原因**: Rez CLI を直接実行する実装が残り、API 経由の `ResolvedContext` を活用できていなかった。
- **対応**: `rez` モジュールの `ResolvedContext` を用いてパッケージ解決と起動を行うように移行し、Rez 実行時の環境構築・テストも API ベースで更新した。

#### Rez 起動時の文字コード例外 (2025-12-19)
- **現象**: Windows 環境で Rez 起動時の標準出力/標準エラーを受信するスレッドで `UnicodeDecodeError` が発生した。
- **原因**: `text=True` の既定 UTF-8 デコードが Windows の出力エンコードと一致せず、バイト列のデコードに失敗した。
- **対応**: `locale.getpreferredencoding(False)` を使って OS 既定のエンコードを指定し、`errors="replace"` でデコード失敗を回避するようにした。

#### Rez shell 実行の無効化 (2025-12-19)
- **現象**: Windows の PowerShell 実行ポリシーにより、Rez の shell 実行で生成されたスクリプトが読み込めず起動が失敗した。
- **原因**: `ResolvedContext.execute_shell` が PowerShell のスクリプト実行を伴い、実行ポリシーに阻まれた。
- **対応**: Rez には `get_environ` で環境変数のみ構築させ、Python 側で `subprocess.Popen` を使ってコマンドを起動する方式へ切り替えた。

#### Rez PATH 汚染の防止 (2025-12-19)
- **現象**: Rez を見つけるための PATH ヒントが親プロセスに永続化され、複数回の起動後に DCC ツールの PATH が混在してクラッシュするケースがあった。
- **原因**: `_apply_rez_path_hint` が `os.environ.update` を実行し、親プロセスの PATH が恒久的に汚染されていた。
- **対応**: PATH ヒントの適用を純粋関数化し、Rez 実行時に渡す env のみに限定。起動時の PATH 先頭ログも任意で出力できるようにした。

#### ツール起動ダイアログの情報不足 (2025-12-19)
- **現象**: ツール起動成功ダイアログで実際に使用した起動コマンドが確認できず、問題切り分けが難しかった。
- **原因**: 起動結果に `command` が含まれているが、ダイアログ側で表示していなかった。
- **対応**: 起動成功ダイアログに `command` を表示し、PID と合わせて起動内容を確認できるようにした。

### main エントリの終了理由判定誤り
- **現象**: Qt アプリケーションのイベントループが非ゼロの終了コードで終わった場合でも、終了理由が手動終了として扱われ、異常終了を自動検知できなかった。
- **原因**: `_run_application` で `app.exec()` の戻り値を考慮せず、例外発生時のみ `reason="error"` を付与していた。
- **対応**: イベントループの戻り値が 0 以外の場合は終了理由を強制的に `"error"` とみなし、レポート出力でも異常終了として扱うよう修正した。テストで非ゼロ終了コードをスタブし、挙動を確認した。

### ノード追加

#### 日付ノードの新設
- **目的**: タイムライン上の節目を示すラベルとして利用できるよう、入出力ポートを持たない日付専用ノードを用意する。
- **対応**: `DateNode` クラスを追加し、コンテンツブラウザとコンテキストメニューから生成できるよう登録した。既定のプロパティとして `date_label` (YYYY-MM-DD) を持ち、ノード幅・高さを初期化する。

#### 日付ノードの描画順とリサイズ挙動不足
- **現象**: 日付ノードが通常ノードと同じレイヤーに描画され、タイムラインの背景装飾として最背面に固定できず、リサイズ時も縦横のグリッドへ揃えられなかった。
- **原因**: `DateNode` を通常の `BaseNode` ベースで実装していたため、バックドロップ特有の z オーダーとスナップ付きリサイズ処理が適用されていなかった。
- **対応**: バックドロップベースの `DateNode` に置き換え、z 値を他ノードより低い位置へ固定。縦横のサイズをスナップしながら変更できるカスタムアイテムを用意し、エディタのグリッド設定と同期させた。

#### 日付ノード初期化時のスナップ設定欠落
- **現象**: 日付ノード生成直後に `_snap_grid_size` が未初期化のままサイズ変更処理が呼ばれ、`AttributeError` でノード生成が失敗する。
- **原因**: バックドロップアイテム初期化の過程でサイザー位置変更ハンドラが先に呼び出され、`_snap_grid_size` をセットする前に `_snap_value` が参照されていた。
- **対応**: バックドロップアイテムのコンストラクタ呼び出しより前に `_snap_grid_size` をデフォルト値で初期化し、生成直後でもスナップ計算が安全に行えるようにした。

#### 日付ノードのスナップ属性参照エラー再発
- **現象**: Windows 環境で日付ノード生成時に再度 `_snap_grid_size` が存在しないと判断され、`AttributeError` が発生した。
- **原因**: Qt の `itemChange` 呼び出しタイミングによっては Python 側のインスタンス属性が未構築と扱われるケースがあり、コンストラクタでセットした `_snap_grid_size` が参照できないままスナップ計算が走っていた。
- **対応**: `_snap_grid_size` をクラス属性としても定義し、`_snap_value` では `getattr` で安全に取得するようガードを追加。コンストラクタ前後どちらのタイミングでもスナップ計算に必要な値が確実に存在するようにした。

#### 日付ノードリサイズ時の無限再入クラッシュ
- **現象**: 日付ノード追加直後にログが出力されないままアプリケーションが終了することがあった。
- **原因**: スナップ後にサイズハンドルの座標を再設定する際、`on_sizer_pos_changed` が再入して無限ループとなり、Qt 側がセグメンテーションフォールトで異常終了していた。
- **対応**: 再入防止フラグと座標比較で不要な再設定を回避し、スナップ中は幅・高さのみ更新するようにしてクラッシュを抑止した。

#### 日付ノードへの子ノード吸着と自動リサイズ
- **現象**: 日付ノードにほかのノードを重ねても吸着せず、ラベルが隠れないような余白確保や子ノードの追従移動が行えなかった。
- **原因**: 日付ノードが縦方向の余白や子ノード管理を持たず、移動イベントでも子ノードの同期移動処理が存在しなかった。
- **対応**: 上下オフセット内を子ノード領域とみなし、中心が入ったノードに合わせて日付ノード高さを自動拡張する処理を追加。内側に収まったノードIDを日付ノードが保持し、日付ノード移動時に子ノードも同じだけシフトさせるようにした。

#### 日付ノード吸着処理でのプロパティ取得欠落
- **現象**: ノード移動時の吸着処理で `_safe_node_property` が未実装のまま呼ばれ、`AttributeError` により日付ノードへの吸着判定が失敗してクラッシュした。
- **原因**: 日付ノードの内側判定にサイズを安全取得するユーティリティを新設したが、呼び出し元に対応する実装を追加し忘れていた。
- **対応**: ノードプロパティ取得をラップする `_safe_node_property` を実装し、`get_property` からの取得失敗をデバッグログに残しつつ、直接属性値も浮動小数へ安全に変換するフォールバックを用意した。

#### 日付ノードの子ノード一覧表示不足
- **現象**: インスペクタの「ノード詳細」から日付ノードに吸着している子ノードを確認できず、どのノードが含まれているか判断しづらかった。
- **原因**: 日付ノードが保持する子ノードIDを UI へ露出する導線がなく、詳細パネルにも表示枠が用意されていなかった。
- **対応**: インスペクタの詳細タブに子ノード欄を追加し、日付ノード選択時に保持している子ノード名を件数付きで列挙するようにした。

#### 日付ノード移動時の子ノード追従と座標ずれ
- **現象**: 日付ノードを子ノードと一緒にドラッグすると子ノードが置いていかれたり、子ノードを外へ動かした際に意図しない位置へ逃げるようにずれてしまうことがあった。
- **原因**: 日付ノード移動時に子ノードも同時にドラッグされているケースを考慮しておらず、同一イベント内で子ノードを二重に移動していた。また、自動リサイズ時のシフト処理がドラッグ中のノードにも適用されていた。
- **対応**: ノード移動イベントで取得した移動中ノードのID集合を共有し、子ノード追従や自動リサイズに伴うシフト処理から除外するようにした。これによりドラッグ操作と自動移動が干渉せず、子ノードが確実に追従するようにした。

#### 日付ノードの位置取得不備による追従失敗
- **現象**: 日付ノードに含めた子ノードがドラッグ時に追従せず、日付ノードを動かした後に周辺ノードが意図せずずれることがあった。
- **原因**: ノード座標の取得ユーティリティ `_safe_node_pos` および `_safe_node_position` が `QPointF` を考慮しておらず、NodeGraphQt から返される座標がすべて `(0, 0)` に丸められていた。そのため日付ノード移動時の移動量がゼロと判定され、子ノードをシフトできていなかった。
- **対応**: `QtCore.QPointF` / `QtCore.QPoint` の場合も x/y から浮動小数へ変換して返すようにし、正しい移動量を計算できるようにした。これにより子ノードの追従と日付ノードの高さ調整が実際の座標に基づいて動作する。

#### 日付ノード追従移動の不具合と選択連動への置換
- **現象**: 日付ノードに子ノードを含めてドラッグしても一緒に移動せず、再度ドラッグすると周辺ノードが逃げるようにずれるなど不安定な挙動が発生した。
- **原因**: 日付ノード移動時に子ノード座標を強制的にシフトする追従処理がドラッグ中の選択状態と干渉し、NodeGraphQt の選択変更イベントと二重に位置を更新していたため。
- **対応**: 追従移動ロジックを全て撤去し、日付ノードを選択すると保持している子ノードを自動で選択に含める仕様へ変更した。これによりドラッグ操作は NodeGraphQt 標準の選択挙動に任せ、不自然な座標ずれを防止した。

#### 日付ノードの初期サイズとリサイズ挙動の不安定さ
- **現象**: 背景グリッド幅と無関係なサイズで日付ノードが生成され、リサイズ時にもサイザー位置が揺れたり描画がちらつくことがあった。
- **原因**: 日付ノードのデフォルト幅・高さを固定値で与えており、背景縞幅と噛み合っていなかった。また、サイザー再配置時に既にスナップ済みの座標へ再設定してしまい、再入時に不要な更新が発生していた。
- **対応**: 背景グリッド幅をもとに日付ノードの初期幅・高さを決定するようにし、サイザー座標が変化しない場合は再設定をスキップするガードを追加して描画の揺らぎを抑制した。

#### 日付ノードのスナップ範囲と自動リサイズの暴走
- **現象**: 日付ノードから遠いノードを動かしても縦方向の拡張が発生し、子ノード判定やスナップが広範囲に及ぶため他ノードが意図せずずれることがあった。
- **原因**: スナップ判定が日付ノードの横幅だけで行われ、上下オフセットを考慮した内側領域を踏んでいなくても高さ拡張が働いていた。また、リサイズ時の余白計算がノードの高さを考慮していなかった。
- **対応**: 日付ノードの上下オフセットを差し引いた内側矩形をスナップ有効範囲として厳密に計算し、その範囲に中心が入ったノードだけを対象に高さを拡張するようにした。拡張時は対象ノードの高さとオフセットを加味して必要な余白を算出し、内側に収まったノードのみ子ノードとして登録するよう調整した。

#### インスペクタでノードプロパティを参照できない
- **現象**: ノードグラフ上のノードを選択しても、インスペクタからノードが保持するプロパティの値を確認する術がなく、設定済みの date_label や環境メタデータの確認が手動でできなかった。
- **原因**: インスペクタの UI にプロパティ一覧の表示領域が存在せず、選択中ノードからプロパティを収集する導線を実装していなかった。
- **対応**: インスペクタに「プロパティ」タブを追加し、選択中ノードのカスタムプロパティと基本プロパティを一覧表示するようにした。ノード選択変更時にプロパティを収集して表示を更新することで、グラフ上に配置したノードの設定値を即座に確認できるようにした。
