# issue.md

## 2024年の記録

### 2024-XX-XX タイムラインオーバーレイ初期化エラー
- **現象**: NodeEditorWindow の初期化時に `TimelineGridOverlay` に `set_column_units` が存在せず `AttributeError` が発生する。
- **原因**: `TimelineGridOverlay` クラスでは列単位を設定するメソッド名が `set_units` のまま実装されており、ウィンドウ側の期待する `set_column_units` と不一致だった。
- **対応**: `TimelineGridOverlay` に互換メソッド `set_column_units` を追加し、内部で既存の `set_units` を呼び出すことで例外を解消。

## 2025年の記録

### タイムラインと背景の改修

#### 2025-XX-XX タイムライン背景描画の刷新
- **現象**: タイムラインの列区切りと日付ラベルが個別のグラフィックスアイテムでオーバーレイ描画されており、背景色の変更要求に対応しづらかった。
- **原因**: 背景やグリッド線を `QGraphicsRectItem` などのシーンアイテムで構成していたため、シーン全体の背景色を直接制御できず、描画コストも高かった。
- **対応**: 背景のタイル生成を `QGraphicsView` の背景ブラシで描画する方式に改め、日付境界のグリッド線も同ブラシで統合的に描画するよう変更した。

#### 2025-XX-XX タイムライン背景の縦軸化とスナップ刷新
- **現象**: タイムライン背景が水平方向基準で実装されており、縦軸で日付スナップさせる要件に適合していなかった。
- **原因**: 背景描画とスナップ制御が横方向（X 軸）固定のまま設計されており、縦方向の座標変換・ラベル配置・スナップ制御を切り替える仕組みが存在しなかった。
- **対応**: タイムライン軸の方向を列挙型で管理し、背景描画・ラベル・今日マーカー・スナップ制御を縦方向へ再設計。ノードエディタでは縦軸を選択して背景とスナップが日付列に揃うよう更新した。

#### 2025-XX-XX ノードエディタ背景色変更が反映されない
- **現象**: タイムライン背景色をカスタマイズしても表示が更新されず、ノードエディタ全体の背景が初期色のまま変化しない。
- **原因**: 背景タイル生成のキャッシュ鍵にテーマ変更が含まれておらず、またテーマ変更時にレイヤへ再適用する手段がなかったため描画が再実行されなかった。
- **対応**: テーマ更新用 API を追加し、背景色変更時にキャッシュを無効化してレイヤへ再適用し即時再描画するよう修正。

#### 2025-XX-XX ノードエディタ背景縞模様の表示確認
- **現象**: NodeGraph の既存グリッド描画と新しい縞模様背景が重複し、ノード幅に揃った境界線が視認できないとの報告があった。
- **対応**: `NodeGraph` 初期化直後に背景タイルを生成し、標準ノード幅を基準とした縞模様ブラシを適用。既存グリッドは `GRID_DISPLAY_NONE` に変更して描画を一本化した。

#### 2025-XX-XX 背景縞幅ドラッグ領域でカーソルが変化しない
- **現象**: 背景縞模様のドラッグ調整が可能な境界にマウスを移動してもカーソルが既定の矢印のままで、ドラッグ可能であることが視覚的に分かりにくかった。
- **原因**: `StripeWidthDragController` のイベントフィルタでホバー状態を処理しておらず、許容範囲内でもカーソル形状を更新するロジックが存在しなかった。
- **対応**: ドラッグ境界の検出ロジックを共通化し、ホバー時に `Qt.SplitHCursor` を設定・解除するメソッドを追加してユーザーにドラッグ可能であることを示すようにした。

#### 2025-XX-XX 背景縞幅変更機能の撤去
- **現象**: ノードエディタ背景の縞幅をユーザーがドラッグやスライダーで変更できる実装が残っており、運用要件で縞幅を固定したいとの要望と矛盾していた。
- **原因**: 過去の UI 改修で導入した幅変更機構が要件変更後もそのまま残存していた。
- **対応**: 縞幅ドラッグ制御とスライダー UI を削除し、背景適用を `apply_striped_background` に一本化。`StripedBackgroundPattern` から幅更新メソッドも除去して機構を完全撤去した。

#### 2025-XX-XX 背景縞幅変更コードの残存
- **現象**: 既存のドキュメントでは縞幅変更機能撤去済みとされていたが、実際には `StripeDragController` などのドラッグ制御コードが残存し、ノードエディタ起動時にハンドルが生成されていた。
- **原因**: 以前の撤去対応が UI 制御コードまで網羅できておらず、背景適用ヘルパーにドラッグ機構が組み込まれたままになっていた。
- **対応**: `stripe_overlay.py` を削除し、`striped_background.py` からドラッグ関連 API を撤去。ノードエディタでは背景適用のみを行い、クローズ処理からもドラッグコントローラの廃棄処理を削除して縞幅固定を徹底した。

#### 2025-XX-XX 背景縞模様の色変更が反映されない
- **現象**: ノードエディタ背景の縞色をテーマから切り替えても、ブラシが既定の明暗配色のままで再描画されなかった。
- **原因**: `StripedBackgroundPattern` が縞幅のみを管理し、色やセグメント構成を変更する API を持たなかったため、外部から色指定を行ってもブラシ生成時に無視されていた。
- **対応**: 幅と任意色を保持する `StripeSegment` データクラスを導入し、パターン更新用の `update_segments` とブラシ再生成ロジックを実装。NodeEditor にはセグメント更新メソッドを追加して、背景縞配色の変更を即時反映できるようにした。

### ノードエディタ UI/機能の調整

#### 2025-XX-XX ノードエディタ背景スナップ・日付表示機能の撤去
- **現象**: タイムラインスナップと日付グリッドが不要になったため、エディタ上に不要な UI が残っていた。
- **原因**: ノード配置を自由化する要件により、従来のスナップ制御および日付オーバーレイが設計上の負債となった。
- **対応**: スナップ制御ロジックとタイムライン描画コンポーネント、関連ドメインモデルとテストを削除し、`NodeEditorWindow` をシンプルな NodeGraph ベースの構成に刷新した。

#### 2025-XX-XX ノードエディタウィンドウの責務肥大化
- **現象**: `NodeEditorWindow` にコンテンツブラウザ、インスペクタ、タイムライン整列ツールなど複数 UI 部品の生成・制御が集約され、クラスの責務が肥大化していた。
- **原因**: ウィンドウカテゴリ内で部品ごとにモジュールを分離せず、全機能を単一クラスに実装していたため再利用性が低くなっていた。
- **対応**: コンテンツブラウザとインスペクタ、整列ツールバーをそれぞれ専用の `QDockWidget`/`QToolBar` 実装へ切り出し、`NodeEditorWindow` はイベント仲介と状態管理に専念するよう再設計した。

#### 2025-XX-XX Ctrl+S 上書き保存の確認ダイアログが存在しない
- **現象**: ノードエディタで `Ctrl+S` による保存を実行すると即座にプロジェクトが上書きされ、意図しない保存を防ぐ手段がなかった。
- **原因**: `NodeEditorWindow._file_save` が保存前の確認ダイアログを表示せず、キーボードショートカットとメニュー操作がそのまま保存処理を呼び出していた。
- **対応**: 保存対象ファイルの有無に応じたメッセージを提示する `_confirm_save_overwrite` を追加し、保存前に必ず `QMessageBox` でユーザー確認を行うよう修正した。

#### 2025-XX-XX ノードエディタ起動時の `viewport` 属性エラー
- **現象**: スタート画面からノードエディタを開くと `NodeGraphWidget` に `viewport` 属性が存在しないとの `AttributeError` で起動できない。
- **原因**: 背景縞幅調整用の `StripeWidthDragController` へ `NodeGraphQt.NodeGraph.widget`（`QTabWidget`）を渡しており、内部で期待される `QGraphicsView` の `viewport()` メソッドが呼び出せなくなっていた。
- **対応**: `NodeGraph` から `viewer()`（`QGraphicsView`）を取得してドラッグコントローラへ渡すよう修正し、縞幅ドラッグのイベントフィルタが適切なビューポートに対して動作するようにした。

#### 2025-XX-XX ノードエディタ起動時の `ModuleNotFoundError`
- **現象**: アプリケーション起動時に `sotugyo.ui.windows.node_snap_controller` が見つからず `ModuleNotFoundError` が発生する。
- **原因**: スナップ機能廃止に伴いモジュールが削除されていたにもかかわらず、`NodeEditorWindow` が不要なインポートを保持していた。
- **対応**: 不要な `NodeSnapController` のインポートを削除し、欠落モジュールへの依存を解消した。

#### 2025-XX-XX NodeGraphQt が要求する `Qt` モジュールが存在しない
- **現象**: `NodeGraphQt` の import 時に `from Qt import QtCore` が解決できず、`ModuleNotFoundError: No module named 'Qt'` が発生する。
- **原因**: プロジェクトが QtPy ベースへ移行した際に、NodeGraphQt が前提とする `Qt.py` 互換モジュールを提供していなかった。
- **対応**: QtPy から `Qt` 名前空間を生成する `sotugyo.qt_compat.ensure_qt_module_alias()` を追加し、NodeGraphQt import 前に呼び出す
  運用に改めて互換性を確保した。

#### 2025-XX-XX NodeGraphQt 初期化時に `QtWidgets.QUndoStack` が欠落する
- **現象**: スタート画面からノードエディタを開くと `QtWidgets.QUndoStack` が存在しないとの `AttributeError` が発生し、`NodeGraph` の初期化に失敗する。
- **原因**: QtPy では Qt6 バインディングにおいて `QUndoStack` や `QActionGroup` などが `QtGui` へ移動しており、`QtWidgets` モジュールに再エクスポートされていなかった。
- **対応**: `sotugyo.qt_compat.ensure_qt_module_alias()` 実行時に `QtGui` 由来のアクション／アンドゥ系クラスを `QtWidgets` へフォールバック登録し、NodeGraphQt が期待する API を提供するよう修正した。

### ツール環境関連

#### 2025-XX-XX ツール環境ノードが実行ファイルパスに依存する
- **現象**: ツール環境ノードが `executable_path` プロパティに実行ファイルパスを保持しており、環境を再現するための情報が不足していた。
- **原因**: ノードがファイルパスを唯一の識別情報として扱っていたため、パスが変化すると環境定義を復元できず、今後追加されるメタデータも保持できない設計だった。
- **対応**: 環境定義やツール識別子を JSON で保持する `environment_payload` を導入し、将来的なメタデータ拡張にも対応できるようにした。
