# issue.md

## 2024年の記録

### 2024-XX-XX タイムラインオーバーレイ初期化エラー
- **現象**: NodeEditorWindow の初期化時に `TimelineGridOverlay` に `set_column_units` が存在せず `AttributeError` が発生する。
- **原因**: `TimelineGridOverlay` クラスでは列単位を設定するメソッド名が `set_units` のまま実装されており、ウィンドウ側の期待する `set_column_units` と不一致だった。
- **対応**: `TimelineGridOverlay` に互換メソッド `set_column_units` を追加し、内部で既存の `set_units` を呼び出すことで例外を解消。

## 2025年の記録

### タイムラインと背景の改修

#### 背景描画の刷新と縦軸対応
- **現象**: タイムライン背景が個別のグラフィックスアイテムで構成されていたため背景色や軸方向の切り替えに柔軟性がなく、描画コストも高かった。
- **原因**: 背景描画・スナップ制御が横方向固定の設計で、ビュー背景色を直接制御できない構造になっていた。
- **対応**: 背景タイル生成を `QGraphicsView` の背景ブラシ描画へ移行し、軸方向を列挙型で管理。日付ラベル・スナップ・今日マーカーを縦軸基準へ再設計した。

#### 背景テーマ更新の反映不具合
- **現象**: 背景色や縞模様の配色変更が即時反映されず、ノードエディタ内で旧テーマが残存するケースがあった。
- **原因**: 背景タイル生成時のキャッシュ鍵にテーマ情報が含まれておらず、色指定を扱う API も不足していた。
- **対応**: テーマ更新 API を追加してキャッシュを無効化する仕組みを導入し、`StripeSegment` データクラスを用いた縞配色更新を実装。NodeGraph 初期化時に縞模様背景を適用し、既存グリッド描画を無効化した。

#### 背景縞幅機構の整理
- **現象**: 運用要件で縞幅固定が求められる中、ドラッグやスライダーによる調整 UI が残存していた。
- **原因**: 過去の UI 改修で導入したドラッグ制御が背景適用ヘルパーに組み込まれたままだった。
- **対応**: `stripe_overlay.py` を含む縞幅ドラッグ関連コードを撤去し、背景適用処理を `apply_striped_background` に一本化。関連するカーソル制御も不要となり削除した。

### ノードエディタ UI/機能の調整

#### スナップ機能撤去とウィンドウ構成の見直し
- **現象**: タイムラインスナップや日付グリッドが不要となった一方で UI が旧仕様のまま残存し、`NodeEditorWindow` の責務も肥大化していた。
- **原因**: スナップ制御やツール群を単一クラスに集約していたため再利用性・保守性が低かった。
- **対応**: スナップ関連ロジックとドメインモデルを削除し、ウィンドウ構成をドック／ツールバー単位へ分割。`NodeEditorWindow` は状態管理とイベント仲介に注力する構成へ改めた。

#### ノードスナップの縦グリッド専用化
- **現象**: スナップ処理が縦横両軸に適用され、縦グリッドとの整合性が崩れるケースがあった。
- **原因**: 汎用スナップとして x/y 両軸を同じルールで丸めていたため、縦グリッドのみを重視する要求と矛盾していた。
- **対応**: スナップ処理を x 座標のみの縦グリッド揃えに限定し、UI 表記も縦グリッド専用であることを明示した。

#### 縦グリッドスナップの背景幅固定化とダイアログエラー
- **現象**: スナップ間隔設定ダイアログを開く際に `QInputDialog.getInt()` で `min` キーワードを渡したことで例外が発生し、起動直後にクラッシュした。
- **原因**: QtPy 経由の API が `min` キーワードを受け付けず、また運用要件としてスナップ幅をユーザー設定にしない方針へ変更されたため UI と処理が乖離していた。
- **対応**: 設定ダイアログ自体を撤去し、背景縞パターンの幅をそのまま縦グリッドスナップ間隔として使用するよう統一した。

#### 縦グリッドスナップ初期化順序エラー
- **現象**: スタート画面からノードエディタを開くと初期化中に `_snap_settings` が未生成のまま参照され、`AttributeError` が発生して起動できない。
- **原因**: 背景適用直後にスナップ間隔同期を呼び出す処理を `_snap_settings` 初期化より前に配置していたため、インスタンス生成順序が逆になっていた。
- **対応**: `NodeEditorWindow` のコンストラクタ内でスナップ設定データクラスを背景同期より先に初期化し、縦グリッドスナップが確実に利用できるようにした。

#### 保存操作と起動安定性の改善
- **現象**: `Ctrl+S` 実行時に確認ダイアログが表示されず意図しない上書きが発生し、同時に背景ドラッグ用コントローラが誤ったウィジェットを参照して `viewport` 属性エラーが発生する場合があった。
- **原因**: `_file_save` が確認処理を持たず、ドラッグコントローラへ `QGraphicsView` ではなく `QTabWidget` を渡していた。
- **対応**: 保存前確認用の `_confirm_save_overwrite` を導入し、ドラッグコントローラには `NodeGraph.viewer()` を渡すよう修正した。

#### Qt 互換レイヤの整備
- **現象**: NodeGraphQt 起動時に `ModuleNotFoundError` や `QtWidgets.QUndoStack` 不足が発生するケースがあった。
- **原因**: QtPy ベースへの移行後も NodeGraphQt が期待する `Qt` 名前空間や Qt6 で `QtGui` 側へ移動したクラスの再エクスポートが不足していた。
- **対応**: `sotugyo.qt_compat.ensure_qt_module_alias()` を追加し、NodeGraphQt import 前に呼び出す運用へ統一。QtGui 由来クラスを `QtWidgets` にフォールバック登録し互換性を確保した。

### ツール環境関連

#### ツール環境ノードのメタデータ強化
- **現象**: ツール環境ノードが実行ファイルパスに依存し、環境再現や将来的なメタデータ拡張に課題があった。
- **原因**: ノードがファイルパスを唯一の識別情報として扱っていた。
- **対応**: 環境定義を JSON 化する `environment_payload` を導入し、識別子とメタデータを拡張可能な形で保持するようにした。

### main エントリの終了理由判定誤り
- **現象**: Qt アプリケーションのイベントループが非ゼロの終了コードで終わった場合でも、終了理由が手動終了として扱われ、異常終了を自動検知できなかった。
- **原因**: `_run_application` で `app.exec()` の戻り値を考慮せず、例外発生時のみ `reason="error"` を付与していた。
- **対応**: イベントループの戻り値が 0 以外の場合は終了理由を強制的に `"error"` とみなし、レポート出力でも異常終了として扱うよう修正した。テストで非ゼロ終了コードをスタブし、挙動を確認した。

### ノード追加

#### 日付ノードの新設
- **目的**: タイムライン上の節目を示すラベルとして利用できるよう、入出力ポートを持たない日付専用ノードを用意する。
- **対応**: `DateNode` クラスを追加し、コンテンツブラウザとコンテキストメニューから生成できるよう登録した。既定のプロパティとして `date_label` (YYYY-MM-DD) を持ち、ノード幅・高さを初期化する。

#### 日付ノードの描画順とリサイズ挙動不足
- **現象**: 日付ノードが通常ノードと同じレイヤーに描画され、タイムラインの背景装飾として最背面に固定できず、リサイズ時も縦横のグリッドへ揃えられなかった。
- **原因**: `DateNode` を通常の `BaseNode` ベースで実装していたため、バックドロップ特有の z オーダーとスナップ付きリサイズ処理が適用されていなかった。
- **対応**: バックドロップベースの `DateNode` に置き換え、z 値を他ノードより低い位置へ固定。縦横のサイズをスナップしながら変更できるカスタムアイテムを用意し、エディタのグリッド設定と同期させた。

#### 日付ノード初期化時のスナップ設定欠落
- **現象**: 日付ノード生成直後に `_snap_grid_size` が未初期化のままサイズ変更処理が呼ばれ、`AttributeError` でノード生成が失敗する。
- **原因**: バックドロップアイテム初期化の過程でサイザー位置変更ハンドラが先に呼び出され、`_snap_grid_size` をセットする前に `_snap_value` が参照されていた。
- **対応**: バックドロップアイテムのコンストラクタ呼び出しより前に `_snap_grid_size` をデフォルト値で初期化し、生成直後でもスナップ計算が安全に行えるようにした。

#### 日付ノードのスナップ属性参照エラー再発
- **現象**: Windows 環境で日付ノード生成時に再度 `_snap_grid_size` が存在しないと判断され、`AttributeError` が発生した。
- **原因**: Qt の `itemChange` 呼び出しタイミングによっては Python 側のインスタンス属性が未構築と扱われるケースがあり、コンストラクタでセットした `_snap_grid_size` が参照できないままスナップ計算が走っていた。
- **対応**: `_snap_grid_size` をクラス属性としても定義し、`_snap_value` では `getattr` で安全に取得するようガードを追加。コンストラクタ前後どちらのタイミングでもスナップ計算に必要な値が確実に存在するようにした。

#### 日付ノードリサイズ時の無限再入クラッシュ
- **現象**: 日付ノード追加直後にログが出力されないままアプリケーションが終了することがあった。
- **原因**: スナップ後にサイズハンドルの座標を再設定する際、`on_sizer_pos_changed` が再入して無限ループとなり、Qt 側がセグメンテーションフォールトで異常終了していた。
- **対応**: 再入防止フラグと座標比較で不要な再設定を回避し、スナップ中は幅・高さのみ更新するようにしてクラッシュを抑止した。

#### 日付ノードへの子ノード吸着と自動リサイズ
- **現象**: 日付ノードにほかのノードを重ねても吸着せず、ラベルが隠れないような余白確保や子ノードの追従移動が行えなかった。
- **原因**: 日付ノードが縦方向の余白や子ノード管理を持たず、移動イベントでも子ノードの同期移動処理が存在しなかった。
- **対応**: 上下オフセット内を子ノード領域とみなし、中心が入ったノードに合わせて日付ノード高さを自動拡張する処理を追加。内側に収まったノードIDを日付ノードが保持し、日付ノード移動時に子ノードも同じだけシフトさせるようにした。

#### 日付ノード吸着処理でのプロパティ取得欠落
- **現象**: ノード移動時の吸着処理で `_safe_node_property` が未実装のまま呼ばれ、`AttributeError` により日付ノードへの吸着判定が失敗してクラッシュした。
- **原因**: 日付ノードの内側判定にサイズを安全取得するユーティリティを新設したが、呼び出し元に対応する実装を追加し忘れていた。
- **対応**: ノードプロパティ取得をラップする `_safe_node_property` を実装し、`get_property` からの取得失敗をデバッグログに残しつつ、直接属性値も浮動小数へ安全に変換するフォールバックを用意した。
