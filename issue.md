# issue.md

## 2024年の記録

### 2024-XX-XX タイムラインオーバーレイ初期化エラー
- **現象**: NodeEditorWindow の初期化時に `TimelineGridOverlay` に `set_column_units` が存在せず `AttributeError` が発生する。
- **原因**: `TimelineGridOverlay` クラスでは列単位を設定するメソッド名が `set_units` のまま実装されており、ウィンドウ側の期待する `set_column_units` と不一致だった。
- **対応**: `TimelineGridOverlay` に互換メソッド `set_column_units` を追加し、内部で既存の `set_units` を呼び出すことで例外を解消。

## 2025年の記録

### タイムラインと背景の改修

#### 背景描画の刷新と縦軸対応
- **現象**: タイムライン背景が個別のグラフィックスアイテムで構成されていたため背景色や軸方向の切り替えに柔軟性がなく、描画コストも高かった。
- **原因**: 背景描画・スナップ制御が横方向固定の設計で、ビュー背景色を直接制御できない構造になっていた。
- **対応**: 背景タイル生成を `QGraphicsView` の背景ブラシ描画へ移行し、軸方向を列挙型で管理。日付ラベル・スナップ・今日マーカーを縦軸基準へ再設計した。

#### 背景テーマ更新の反映不具合
- **現象**: 背景色や縞模様の配色変更が即時反映されず、ノードエディタ内で旧テーマが残存するケースがあった。
- **原因**: 背景タイル生成時のキャッシュ鍵にテーマ情報が含まれておらず、色指定を扱う API も不足していた。
- **対応**: テーマ更新 API を追加してキャッシュを無効化する仕組みを導入し、`StripeSegment` データクラスを用いた縞配色更新を実装。NodeGraph 初期化時に縞模様背景を適用し、既存グリッド描画を無効化した。

#### 背景縞幅機構の整理
- **現象**: 運用要件で縞幅固定が求められる中、ドラッグやスライダーによる調整 UI が残存していた。
- **原因**: 過去の UI 改修で導入したドラッグ制御が背景適用ヘルパーに組み込まれたままだった。
- **対応**: `stripe_overlay.py` を含む縞幅ドラッグ関連コードを撤去し、背景適用処理を `apply_striped_background` に一本化。関連するカーソル制御も不要となり削除した。

### ノードエディタ UI/機能の調整

#### スナップ機能撤去とウィンドウ構成の見直し
- **現象**: タイムラインスナップや日付グリッドが不要となった一方で UI が旧仕様のまま残存し、`NodeEditorWindow` の責務も肥大化していた。
- **原因**: スナップ制御やツール群を単一クラスに集約していたため再利用性・保守性が低かった。
- **対応**: スナップ関連ロジックとドメインモデルを削除し、ウィンドウ構成をドック／ツールバー単位へ分割。`NodeEditorWindow` は状態管理とイベント仲介に注力する構成へ改めた。

#### 保存操作と起動安定性の改善
- **現象**: `Ctrl+S` 実行時に確認ダイアログが表示されず意図しない上書きが発生し、同時に背景ドラッグ用コントローラが誤ったウィジェットを参照して `viewport` 属性エラーが発生する場合があった。
- **原因**: `_file_save` が確認処理を持たず、ドラッグコントローラへ `QGraphicsView` ではなく `QTabWidget` を渡していた。
- **対応**: 保存前確認用の `_confirm_save_overwrite` を導入し、ドラッグコントローラには `NodeGraph.viewer()` を渡すよう修正した。

#### Qt 互換レイヤの整備
- **現象**: NodeGraphQt 起動時に `ModuleNotFoundError` や `QtWidgets.QUndoStack` 不足が発生するケースがあった。
- **原因**: QtPy ベースへの移行後も NodeGraphQt が期待する `Qt` 名前空間や Qt6 で `QtGui` 側へ移動したクラスの再エクスポートが不足していた。
- **対応**: `sotugyo.qt_compat.ensure_qt_module_alias()` を追加し、NodeGraphQt import 前に呼び出す運用へ統一。QtGui 由来クラスを `QtWidgets` にフォールバック登録し互換性を確保した。

### ツール環境関連

#### 2025-XX-XX ツール環境ノードが実行ファイルパスに依存する
- **現象**: ツール環境ノードが `executable_path` プロパティに実行ファイルパスを保持しており、環境を再現するための情報が不足していた。
- **原因**: ノードがファイルパスを唯一の識別情報として扱っていたため、パスが変化すると環境定義を復元できず、今後追加されるメタデータも保持できない設計だった。
- **対応**: 環境定義やツール識別子を JSON で保持する `environment_payload` を導入し、将来的なメタデータ拡張にも対応できるようにした。

#### 2025-XX-XX プロジェクト固有の Rez パッケージが保存・検証されない
- **現象**: ツール環境ノードをプロジェクトに追加しても Rez パッケージ構成がプロジェクト側へ保存されず、再読み込み時にマシンのツ
  ール登録内容へ合わせた検証が行えなかった。
- **原因**: プロジェクト配下に Rez パッケージを永続化する仕組みがなく、マシン共通のツールレジストリにのみ情報を保持していた。
- **対応**: `config/envs/rez_packages.json` を管理する `ProjectRezPackageRepository` を実装し、保存時にツールディレクトリを環境変数に
  反映した Rez パッケージを記録、読み込み時には最新のマシン環境で検証するフローを追加した。
