# issue.md

## 目的
過去の不具合・設計変更を「現象 / 原因 / 対応」の最小限で把握できるよう、要点を短く整理する。

## 2024年

### タイムラインオーバーレイ初期化エラー
- **現象**: `TimelineGridOverlay` で `AttributeError` が発生。
- **原因**: `set_column_units` が未実装で `set_units` のままだった。
- **対応**: 互換メソッド `set_column_units` を追加し、`set_units` を呼び出すよう修正。

## 2025年

### タイムライン / 背景描画
- **背景描画の刷新**
  - **現象**: 背景色・軸切替・描画コストに課題。
  - **原因**: 背景が個別アイテムで横方向固定の設計だった。
  - **対応**: `QGraphicsView` の背景ブラシへ移行し、縦軸対応と列挙型管理へ再設計。
- **テーマ更新の反映遅延**
  - **現象**: 配色変更が即時反映されない。
  - **原因**: 背景タイルのキャッシュ鍵にテーマ情報が不足。
  - **対応**: テーマ更新 API とキャッシュ無効化、`StripeSegment` で配色更新。
- **縞幅固定化**
  - **現象**: 縞幅調整 UI が残存。
  - **原因**: 過去のドラッグ制御がコードに残っていた。
  - **対応**: ドラッグ関連コードを削除し `apply_striped_background` に統一。

### ノードエディタ UI / 仕様整理
- **スナップ撤去とウィンドウ分割**
  - **現象**: 不要機能が残存、`NodeEditorWindow` が肥大化。
  - **原因**: スナップやツール群を単一クラスに集約。
  - **対応**: スナップ関連を削除し、ドック / ツールバーへ分割。
- **縦グリッド専用スナップ化**
  - **現象**: 縦グリッドと整合しないスナップが発生。
  - **原因**: x/y を同一ルールで丸めていた。
  - **対応**: x 座標のみの縦グリッドスナップに限定。
- **スナップ間隔ダイアログ削除**
  - **現象**: `QInputDialog.getInt(min=...)` で例外。
  - **原因**: QtPy API が `min` を受け付けない。
  - **対応**: ダイアログ撤去、背景縞幅をスナップ間隔に統一。
- **スナップ設定初期化順序エラー**
  - **現象**: `_snap_settings` 未生成で `AttributeError`。
  - **原因**: 背景同期が初期化より先に呼ばれていた。
  - **対応**: コンストラクタで初期化順序を調整。
- **保存確認とドラッグ対象の修正**
  - **現象**: 保存確認がなく誤上書き、`viewport` 属性エラー。
  - **原因**: 確認処理不足・誤ウィジェット参照。
  - **対応**: `_confirm_save_overwrite` を追加し `NodeGraph.viewer()` を参照。
- **Qt 互換レイヤ不足**
  - **現象**: `ModuleNotFoundError` など互換不足。
  - **原因**: `Qt` 名前空間や Qt6 移動クラスの再エクスポート不足。
  - **対応**: `ensure_qt_module_alias()` で互換性を確保。

### ツール環境 / Rez
- **環境定義メタデータ強化**
  - **現象**: 実行ファイル依存で拡張が困難。
  - **原因**: パスのみを識別子に使用。
  - **対応**: JSON 化した `environment_payload` を導入。
- **Rez パッケージ自動生成**
  - **現象**: 登録作業の手動対応が必要。
  - **原因**: テンプレートと Rez 設定が分離。
  - **対応**: テンプレート探索から Rez パッケージを自動生成。
- **起動ボタン追加**
  - **現象**: UI から Rez 起動できない。
  - **原因**: 起動アクション未実装。
  - **対応**: インスペクタに起動ボタンを追加。
- **ツール登録と環境定義の統合**
  - **現象**: 二重管理で整合性が崩れる。
  - **原因**: RegisteredTool 依存設計が残存。
  - **対応**: Rez パッケージ生成 + 環境定義保存へ統合。
- **Rez パッケージのバージョン制約追加**
  - **現象**: `rez_packages` にバージョンが欠落。
  - **原因**: `version_label` を参照していなかった。
  - **対応**: `tool_id` / `version_label` を参照して `-<version>` を付与。
- **統合テスト追加**
  - **現象**: Rez 起動フローがテストされていない。
  - **原因**: 統合テスト未整備。
  - **対応**: `dummyTool.exe.test` を使った起動テストを追加。
- **環境識別の統一**
  - **現象**: `environment_id` とパッケージ名の二重管理。
  - **原因**: 旧 ID 参照が残っていた。
  - **対応**: `environment_id` を撤廃しパッケージ名参照へ統一。
- **Rez 実行方法の統一**
  - **現象**: `rez` コマンド前提で環境依存。
  - **原因**: `python -m rez` への移行が未反映。
  - **対応**: `python -m rez env` へ統一、標準出力を print。
- **rez 実体の解決**
  - **現象**: `python -m rez` のみで要件不足。
  - **原因**: `Scripts/rez` / `bin/rez` の探索が未実装。
  - **対応**: `sys.executable` 起点で rez 実体を探索して実行。

### main エントリの終了理由判定
- **現象**: `app.exec()` が非ゼロでも手動終了扱い。
- **原因**: 戻り値を終了理由へ反映していなかった。
- **対応**: 非ゼロ終了は `reason="error"` として扱う。

### 日付ノード
- **追加**
  - **目的**: タイムライン上の節目を示す日付ラベル。
  - **対応**: `DateNode` を追加し、生成導線を登録。
- **描画順とリサイズ**
  - **現象**: 背景レイヤー化とスナップが不十分。
  - **原因**: 通常 `BaseNode` ベースだった。
  - **対応**: バックドロップベースへ置換し z 値を最背面に固定。
- **スナップ初期化不足**
  - **現象**: `_snap_grid_size` 未初期化でクラッシュ。
  - **原因**: 初期化順序の問題。
  - **対応**: デフォルト値を先に設定。
- **Windows での属性参照不備**
  - **現象**: `AttributeError` が再発。
  - **原因**: Qt の `itemChange` タイミング差異。
  - **対応**: クラス属性 + `getattr` でガード。
- **リサイズ再入クラッシュ**
  - **現象**: 無限再入で異常終了。
  - **原因**: サイザー再設定が再入を誘発。
  - **対応**: 再入防止フラグと座標比較で抑止。
- **子ノード吸着と自動リサイズ**
  - **現象**: 子ノード吸着や余白確保ができない。
  - **原因**: 子ノード管理が未実装。
  - **対応**: 内側領域判定と自動拡張、ID 保持を追加。
- **プロパティ取得ユーティリティ不足**
  - **現象**: `_safe_node_property` 未実装でクラッシュ。
  - **原因**: 実装漏れ。
  - **対応**: 安全取得とフォールバックを追加。
- **子ノード一覧表示不足**
  - **現象**: インスペクタで子ノードが見えない。
  - **原因**: 表示導線が未実装。
  - **対応**: 子ノード欄と件数表示を追加。
- **追従移動の不安定さ**
  - **現象**: ドラッグ時のずれ・追従失敗。
  - **原因**: 追従移動と選択変更が干渉。
  - **対応**: 追従移動を撤去し選択連動へ置換。
- **位置取得の不備**
  - **現象**: 位置が `(0, 0)` で扱われる。
  - **原因**: `QPointF/QPoint` 変換未対応。
  - **対応**: 浮動小数へ変換して正確化。
- **初期サイズとリサイズの揺らぎ**
  - **現象**: 背景縞幅と不整合、描画が揺れる。
  - **原因**: 固定値初期化と再設定が過剰。
  - **対応**: 背景幅から初期値を算出、再設定ガード追加。
- **スナップ範囲と自動リサイズ暴走**
  - **現象**: 遠方ノードでも拡張が発生。
  - **原因**: 判定が横幅のみで上下オフセット未考慮。
  - **対応**: 内側矩形判定と余白計算を厳密化。

### インスペクタのプロパティ表示
- **現象**: ノードのプロパティ値が確認できない。
- **原因**: 表示領域が存在しない。
- **対応**: プロパティタブを追加して一覧表示。
