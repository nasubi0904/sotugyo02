# ツール配布および開発計画

## 1. 目的
- **Python 3.11** と **PySide6** を用いて Maya 向けアセットツールを提供する。
- バイナリ凍結を避けつつ、ポータブルに配布可能な環境を整える。
- コンソールを表示しないシームレスなランチャーを用意し、非技術ユーザーでも簡単に起動できるようにする。

## 想定ワークフロー
- ツール起動時にプロジェクト選択ダイアログを表示し、利用者が対象プロジェクトを決定する。
- 選択内容に応じたノードグラフビューを開き、全体の処理フローを俯瞰できるようにする。
- ノードグラフ上でツールノードやチェックノードを選択し、右ペインまたはモーダルで詳細設定を編集する。

## 2. 配布戦略の概要
- **ランタイム**: 公式の **Windows 用 Python 3.11 Embeddable Package** を同梱する。
- **依存関係**: PySide6 などのサードパーティライブラリを `site-packages` ディレクトリに配置し、`_pth` から参照する。
- **アプリケーションコード**: 内製スクリプトは `zipapp` でまとめた `app.pyz` として提供する。
- **ランチャー**: `pythonw.exe` を用いて zipapp を実行し、ユーザーはショートカットやバッチをダブルクリックするだけで起動できるようにする。

## 3. ディレクトリ構成（ドラフト）
```
/ToolRoot
  /python/                <- Embeddable runtime（python.exe、pythonw.exe、python311.zip、python311._pth を配置）
  /site-packages/         <- PySide6 およびサードパーティライブラリを格納
  /app/
    app.pyz               <- zipapp 化したスタジオスクリプト
  start_tool.bat          <- Windows 用ランチャー（python\pythonw.exe app\app.pyz を呼び出す）
  start_tool.ps1          <- PowerShell 版ランチャー（任意）
  README.md               <- 利用者向けクイックスタートガイド
```

## 4. ランチャーの挙動
1. `start_tool.bat` は作業ディレクトリをツールルートに設定する。
2. 必要に応じて `PYTHONPATH` を設定し、zipapp から `site-packages` を参照できるようにする。
3. `python\pythonw.exe app\app.pyz` を実行する。
4. zipapp のブートストラップで `site-packages` やカスタム設定ディレクトリを `sys.path` に追加し、GUI エントリポイントを読み込む。

## 5. 開発ワークフロー
- 編集しやすいソースツリー（例: `src/`）で開発し、仮想環境を用いて迅速に検証する。
- ビルドスクリプト（例: `scripts/build_zipapp.py`）を用意し、以下を自動化する。
  1. ステージングフォルダの同期・クリーンアップ。
  2. ランタイムリソースのコピー。
  3. `python -m zipapp` を実行して `src` から `app/app.pyz` を生成。
  4. `python311._pth` に相対パスで `site-packages` などの検索パスを追記。
- バイナリランタイムなどの大容量ファイルはバージョン管理に含めず、構成手順とテンプレートのみを管理する。

## 6. 設定と拡張性
- キャッシュやログ、プロジェクトルートといった絶対パスは環境変数または `config/tool_settings.toml` のようなユーザー編集可能な設定から解決する。
- 既定では `%LOCALAPPDATA%/StudioTool/logs` にローテーションするログファイルを書き出し、`--debug` 指定時はコンソール出力も有効化する。
- `plugins/` ディレクトリを `sys.path` に追加してプラグインフックを提供する。

## 画面遷移と操作ステップ
- **第一層（プロジェクト階層）**: PySide6 のメインウィンドウにプロジェクトセレクタを配置し、NodeGraphQt のビューとは分離したステートを保持する。選択完了後に `NodeGraphWindow` を初期化し、関連リソースをロードする。
- **第二層（ノードグラフ階層）**: NodeGraphQt の `NodeGraph` ウィジェットを中心に、ツリービューによる検索やフィルタリングをサイドバーに提供する。ノード選択時には PySide6 のスタックウィジェットで詳細パネルへ遷移し、Runner 設定や承認ゲートを編集できるようにする。
- **TICKET 発行フロー**: ノードのバリデーション完了後、コンテキストメニューから「TICKET 発行」を選択 → チェックノードで承認履歴を確認 → TICKET 作成ダイアログで必要項目を入力 → 発行ボタンでバックエンド API を呼び出す → 完了メッセージと共に履歴ビューへ反映する。

## 7. テストと品質保証
- 自動テストは開発用仮想環境上のソースツリーに対して実行する。
- クリーンな Windows VM 上で `start_tool.bat` をダブルクリックするスモークテストを実施し、zipapp が問題なく起動することを確認する。
- CI 上で `python311._pth` とパッケージ構成が同期しているかの検証を追加する。

## UI 要件の詳細
- **タスク実行履歴**: メインウィンドウ下部にタブ切り替え可能なログビューを設置し、各ノードの実行時刻・担当者・結果を時系列で表示する。
- **承認ゲート**: チェックノードに承認ステータスと承認者コメント欄を持たせ、承認待ち／承認済みが一目で分かるバッジをノード上に重ねる。
- **ノード内 Runner リスト**: 各ツールノードの詳細ペインに Runner（スクリプトやコマンド）の一覧を表示し、順序変更や有効／無効切り替えを行える編集 UI を提供する。
- **スクリーン構成概略**:
  - 上段: プロジェクト情報バー（現在のプロジェクト、担当、承認状況のサマリ）。
  - 左ペイン: ノードグラフおよびフィルタリング用ツリー。
  - 右ペイン: 選択ノードの詳細設定（Runner リスト、承認ゲート、入出力設定）。
  - 下段: タスク実行履歴タブと TICKET 発行・承認操作のステータスログ。

## 8. 次のステップ
1. `sys.path` を調整する zipapp 内ブートストラップスクリプトの試作。
2. ビルドスクリプトのドラフト作成と、必要なアーティファクト（PySide6 の Wheel ファイル、ランタイム ZIP）のドキュメント化。
3. パッケージングの検証用に PySide6 の GUI スケルトン（アバウトダイアログ等）を作成。
4. インストール手順とトラブルシュートをまとめた利用者向け README を作成。
